<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EconoDeal — Canada</title>
  <style>
    :root{
      --bg:#020617; --panel:#0b1120; --panel-2:#111c33; --text:#e5e7eb;
      --muted:#94a3b8; --accent:#22c55e; --border:rgba(45,69,110,.6); --radius:14px;
      --glow-1:rgba(34,197,94,.25); --glow-2:rgba(59,130,246,.25); --glow-3:rgba(244,114,182,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(circle at 20% -10%,rgba(59,130,246,.28),transparent 55%),radial-gradient(circle at 80% 0,rgba(34,197,94,.22),transparent 50%),linear-gradient(180deg,var(--bg),#020817 50%,#040913);color:var(--text);min-height:100vh;position:relative;overflow-x:hidden}
    .bg-visuals{position:fixed;inset:0;pointer-events:none;z-index:0;mix-blend-mode:screen;opacity:.8}
    .bg-visuals::before{content:"";position:absolute;inset:-20% -10%;background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.35),transparent 55%),radial-gradient(circle at 80% 30%,rgba(34,197,94,.35),transparent 50%),radial-gradient(circle at 60% 80%,rgba(244,114,182,.25),transparent 45%);filter:blur(40px);opacity:.6}
    .bg-visuals::after{content:"";position:absolute;inset:0;background:linear-gradient(130deg,rgba(34,197,94,.35) 0%,rgba(59,130,246,.15) 35%,rgba(14,165,233,.25) 65%,rgba(147,51,234,.25) 100%);mask-image:radial-gradient(circle at 50% 30%,rgba(255,255,255,.28),transparent 65%);opacity:.45}
    .bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(59,130,246,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.06) 1px,transparent 1px);background-size:120px 120px;mask-image:radial-gradient(circle at 50% 40%,rgba(255,255,255,.3),transparent 70%)}
    .bg-orb{position:absolute;width:320px;height:320px;border-radius:50%;filter:blur(40px);opacity:.6;animation:floatOrb 16s ease-in-out infinite}
    .bg-orb--one{top:10%;left:10%;background:var(--glow-1);animation-delay:-2s}
    .bg-orb--two{bottom:12%;right:12%;background:var(--glow-2);animation-delay:-5s}
    .bg-orb--three{top:40%;right:20%;background:var(--glow-3);animation-delay:-9s}
    @keyframes floatOrb{0%,100%{transform:translate3d(0,0,0) scale(1)}50%{transform:translate3d(20px,-30px,0) scale(1.15)}}
    header{position:sticky;top:0;z-index:20;background:rgba(8,13,26,.78);backdrop-filter:blur(12px);border-bottom:1px solid rgba(59,130,246,.18);box-shadow:0 20px 40px rgba(15,23,42,.35)}
    .container{max-width:1140px;margin:0 auto;padding:18px;position:relative;z-index:1}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .brand{display:inline-flex;align-items:center;gap:12px;padding:8px 18px;border-radius:14px;text-decoration:none;color:var(--text);background:linear-gradient(120deg,rgba(34,197,94,.12),rgba(59,130,246,.18));border:1px solid rgba(34,197,94,.35);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,filter .3s ease}
    .brand:hover{transform:translateY(-2px) scale(1.01);box-shadow:0 18px 36px rgba(34,197,94,.22);background:linear-gradient(120deg,rgba(34,197,94,.18),rgba(59,130,246,.25));filter:drop-shadow(0 0 12px rgba(34,197,94,.25))}
    .brand img{width:46px;height:46px;display:block}
    .brand-text{display:flex;flex-direction:column;line-height:1.1}
    .brand-title{margin:0;font-size:18px;font-weight:700;letter-spacing:-.01em}
    .brand-tagline{font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:#86efac;font-weight:600}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="range"],button{background:linear-gradient(160deg,rgba(15,23,42,.95),rgba(30,41,59,.9));background-color:#0f172a;color:var(--text);border:1px solid rgba(148,163,184,.3);border-radius:10px;padding:10px 12px;box-shadow:0 0 0 1px rgba(2,6,23,.45) inset;transition:border-color .3s ease,box-shadow .3s ease,transform .2s ease}
    select option{color:#0f172a;background:#f8fafc}
    input[type="text"],input[type="email"]{width:100%;background:linear-gradient(170deg,rgba(17,24,39,.92),rgba(17,34,64,.9));color:var(--text);border:1px solid rgba(148,163,184,.3);border-radius:10px;padding:10px 12px;box-shadow:0 0 0 1px rgba(2,6,23,.35) inset;transition:border-color .3s ease,box-shadow .3s ease}
    input[type="text"]:focus,input[type="email"]:focus{border-color:rgba(59,130,246,.65);box-shadow:0 0 18px rgba(59,130,246,.25)}
    .nav-button{display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(160deg,rgba(15,23,42,.94),rgba(20,33,54,.9));color:var(--text);border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:10px 12px;text-decoration:none;transition:background .3s ease,color .3s ease,box-shadow .3s ease}
    .nav-button:hover{background:linear-gradient(140deg,rgba(34,197,94,.22),rgba(59,130,246,.24));color:#fff;box-shadow:0 8px 20px rgba(59,130,246,.25)}
    .nav-button.current{background:linear-gradient(120deg,rgba(34,197,94,.32),rgba(59,130,246,.35));border-color:rgba(34,197,94,.6);box-shadow:0 12px 26px rgba(34,197,94,.2)}
    .country-toggle{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(160deg,rgba(14,23,39,.94),rgba(25,39,70,.92));padding:6px;border-radius:12px;border:1px solid rgba(59,130,246,.25);box-shadow:0 8px 18px rgba(2,6,23,.45) inset,0 10px 30px rgba(2,6,23,.4)}
    .country-toggle--header{background:rgba(8,13,26,.85);border-color:rgba(148,163,184,.4);box-shadow:0 10px 24px rgba(8,13,26,.45)}
    .country-toggle--header .country-button{padding:8px 16px}
    .country-toggle .country-button{background:transparent;border:none;color:var(--muted);padding:8px 14px;border-radius:8px;font-weight:600;cursor:pointer;transition:background .3s ease,color .3s ease,transform .2s ease}
    .country-toggle .country-button:hover{color:#fff;background:rgba(59,130,246,.22);transform:translateY(-1px)}
    .country-toggle .country-button.active,.country-toggle .country-button[aria-pressed="true"]{background:linear-gradient(120deg,rgba(34,197,94,.3),rgba(59,130,246,.28));color:#fff;box-shadow:0 6px 18px rgba(59,130,246,.25)}
    .country-toggle .country-button:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    select:focus,input[type="range"]:focus,button:focus,.nav-button:focus{outline:2px solid var(--accent);outline-offset:1px}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;background:linear-gradient(160deg,rgba(11,19,36,.8),rgba(22,35,58,.72));border:1px solid rgba(59,130,246,.18);padding:16px;border-radius:16px;box-shadow:0 12px 32px rgba(2,6,23,.45)}
    .field-helper{font-size:12px;color:var(--muted);margin:6px 0 0}
    .field-helper.error{color:#fca5a5}
    input[aria-invalid="true"],select[aria-invalid="true"]{border-color:#ef4444;box-shadow:0 0 0 1px rgba(239,68,68,.25)}
    .header-region{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(120deg,rgba(59,130,246,.18),rgba(34,197,94,.2));border:1px solid rgba(59,130,246,.35);color:var(--text);border-radius:999px;padding:6px 12px;font-size:11px;font-weight:600;letter-spacing:.16em;text-transform:uppercase;white-space:nowrap;box-shadow:0 8px 18px rgba(15,23,42,.45)}
    @media (max-width:900px){.filters{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.filters{grid-template-columns:1fr}}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:linear-gradient(200deg,rgba(12,19,35,.96),rgba(17,30,54,.94));border:1px solid rgba(59,130,246,.2);border-radius:var(--radius);overflow:hidden;position:relative;box-shadow:0 14px 32px rgba(2,6,23,.6)}
    .card::before{content:"";position:absolute;inset:0;border-radius:inherit;border:1px solid rgba(59,130,246,.25);opacity:0;transition:opacity .4s ease}
    .card:hover::before{opacity:1;box-shadow:0 0 22px rgba(59,130,246,.35)}
    .card img{width:100%;height:140px;object-fit:cover;background:#05070f;filter:saturate(1.1)}
    .card .body{padding:14px;display:grid;gap:10px}
    .price{display:flex;gap:10px;align-items:baseline;margin:6px 0}
    .price .old{text-decoration:line-through;color:var(--muted)}
    .badge{display:inline-flex;gap:6px;align-items:center;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac;border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:10px 12px;border-radius:10px;font-weight:600;text-decoration:none;font-size:14px;transition:background .2s ease,color .2s ease,border-color .2s ease}
    .btn-primary{background:linear-gradient(120deg,rgba(34,197,94,.88),rgba(59,130,246,.82));color:#fff;border:none;box-shadow:0 12px 24px rgba(34,197,94,.25)}
    .btn-primary:hover{background:linear-gradient(120deg,rgba(34,197,94,.95),rgba(59,130,246,.9));box-shadow:0 16px 30px rgba(34,197,94,.28)}
    .btn-secondary{background:linear-gradient(160deg,rgba(15,23,42,.9),rgba(24,37,64,.88));color:var(--text);border:1px solid rgba(148,163,184,.35);box-shadow:0 6px 16px rgba(15,23,42,.45)}
    .btn-secondary:hover{background:linear-gradient(160deg,rgba(59,130,246,.2),rgba(24,37,64,.92));color:#fff;border-color:rgba(59,130,246,.55);box-shadow:0 12px 24px rgba(59,130,246,.25)}
    .comparison-links{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .action-stack{display:grid;gap:8px;margin-top:4px}
    .section{padding:32px 0}
    .muted{color:var(--muted)}
    .footer{border-top:1px solid rgba(59,130,246,.18);padding:28px 0;color:var(--muted);text-align:center;background:linear-gradient(180deg,rgba(9,14,24,.85),rgba(4,7,12,.95))}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:var(--panel-2);border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:var(--muted)}
    .dev-banner{background:#1f2937;border:1px dashed #ef4444;color:#fecaca;padding:10px 12px;border-radius:10px;margin:12px 0;display:none}
    .pricing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:18px}
    .pricing-card{background:linear-gradient(200deg,rgba(10,19,34,.92),rgba(10,24,44,.9));border:1px solid rgba(59,130,246,.24);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;gap:14px;position:relative;overflow:hidden;box-shadow:0 20px 44px rgba(2,6,23,.55);transition:transform .3s ease,box-shadow .3s ease}
    .pricing-card::before{content:"";position:absolute;inset:0 0 auto 0;height:3px;background:linear-gradient(90deg,rgba(34,197,94,.6),rgba(59,130,246,.6));opacity:.6}
    .pricing-card::after{content:"";position:absolute;inset:auto -40% -40% auto;width:200px;height:200px;background:radial-gradient(circle,rgba(59,130,246,.22),transparent 60%);filter:blur(30px);opacity:.4;transition:opacity .3s ease}
    .pricing-card:hover{transform:translateY(-6px);box-shadow:0 28px 54px rgba(15,23,42,.6)}
    .pricing-card:hover::after{opacity:.6}
    .pricing-card h4{margin:0;font-size:18px}
    .pricing-price{font-size:28px;font-weight:700;color:#bbf7d0}
    .pricing-features{list-style:none;padding:0;margin:0;display:grid;gap:8px;font-size:14px;color:var(--muted)}
    .pricing-tag{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .pricing-highlight{outline:2px solid rgba(34,197,94,.4);outline-offset:4px;transition:outline-color .3s ease}
    @keyframes pricingPulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}70%{box-shadow:0 0 0 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    #pricing.pricing-pulse{animation:pricingPulse 1.3s ease-out 1}
    .roadmap{background:linear-gradient(200deg,rgba(10,18,33,.9),rgba(8,18,36,.95));border:1px solid rgba(59,130,246,.25);border-radius:var(--radius);padding:26px;display:grid;gap:18px;margin-top:26px;position:relative;overflow:hidden;box-shadow:0 26px 60px rgba(2,6,23,.6)}
    .roadmap::before{content:"Roadmap stratégique";position:absolute;top:16px;right:-80px;width:220px;text-align:center;transform:rotate(45deg);background:linear-gradient(120deg,rgba(34,197,94,.22),rgba(59,130,246,.24));border:1px solid rgba(34,197,94,.35);color:#86efac;padding:6px 0;font-size:12px;letter-spacing:.08em;text-transform:uppercase;box-shadow:0 12px 28px rgba(15,23,42,.45)}
    .roadmap-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .roadmap-card{background:linear-gradient(200deg,rgba(12,22,42,.92),rgba(11,21,37,.88));border:1px solid rgba(59,130,246,.24);border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;box-shadow:0 18px 40px rgba(2,6,23,.55)}
    .roadmap-card::after{content:"";position:absolute;inset:auto -50% -50% auto;width:220px;height:220px;background:radial-gradient(circle,rgba(59,130,246,.2),transparent 60%);filter:blur(28px);opacity:.45}
    .roadmap-year{font-size:12px;text-transform:uppercase;letter-spacing:.1em;color:rgba(148,163,184,.85)}
    .roadmap-year strong{display:block;font-size:20px;color:var(--text)}
    .roadmap-card ul{margin:0;padding-left:18px;display:grid;gap:6px;font-size:14px;color:rgba(226,232,240,.75)}
    .roadmap-ai{border-left:3px solid var(--accent);padding-left:12px;background:linear-gradient(160deg,rgba(34,197,94,.18),rgba(59,130,246,.15));border-radius:10px;box-shadow:0 14px 32px rgba(34,197,94,.18)}
    @media (max-width:600px){.roadmap::before{right:-120px}}
    .notice-card{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.35);color:#bfdbfe;border-radius:12px;padding:18px;font-size:14px;line-height:1.55}
    .amazon-section{background:linear-gradient(200deg,rgba(9,16,28,.88),rgba(8,20,40,.92));border:1px solid rgba(59,130,246,.28);border-radius:var(--radius);padding:28px;display:grid;gap:24px;margin-top:32px;box-shadow:0 26px 60px rgba(2,6,23,.6)}
    .amazon-section h2{margin:0;font-size:28px;display:flex;align-items:center;gap:10px}
    .amazon-section h2::after{content:"⚡";font-size:20px;opacity:.7}
    .amazon-intro{font-size:16px;line-height:1.65;color:var(--muted);max-width:780px;margin:0}
    .seller-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px}
    .seller-metric{background:linear-gradient(160deg,rgba(34,197,94,.16),rgba(59,130,246,.12));border:1px solid rgba(59,130,246,.35);border-radius:14px;padding:16px;display:grid;gap:4px;position:relative;overflow:hidden;box-shadow:0 14px 32px rgba(15,23,42,.45)}
    .seller-metric strong{font-size:24px;color:#bbf7d0}
    .seller-metric span{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:rgba(226,232,240,.8)}
    .seller-metric p{margin:0;font-size:13px;color:rgba(226,232,240,.75);line-height:1.4}
    .seller-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .seller-card{background:linear-gradient(200deg,rgba(13,24,44,.92),rgba(11,19,35,.88));border:1px solid rgba(59,130,246,.28);border-radius:16px;padding:20px;display:grid;gap:12px;position:relative;overflow:hidden;box-shadow:0 18px 42px rgba(2,6,23,.55);transition:transform .3s ease,box-shadow .3s ease}
    .seller-card::before{content:"";position:absolute;inset:0 auto auto 0;width:3px;background:linear-gradient(180deg,rgba(34,197,94,.7),rgba(59,130,246,.55));opacity:.8}
    .seller-card::after{content:"";position:absolute;inset:auto -40% -40% auto;width:220px;height:220px;background:radial-gradient(circle,rgba(59,130,246,.25),transparent 60%);filter:blur(30px);opacity:.5;transition:opacity .3s ease}
    .seller-card:hover{transform:translateY(-6px);box-shadow:0 26px 50px rgba(15,23,42,.65)}
    .seller-card:hover::after{opacity:.7}
    .seller-card h3{margin:0;font-size:18px;color:#fff;letter-spacing:-.01em}
    .seller-card p{margin:0;font-size:14px;color:rgba(203,213,225,.82);line-height:1.55}
    .seller-icon{font-size:32px;filter:drop-shadow(0 0 10px rgba(34,197,94,.4))}
    .seller-list{list-style:none;padding:0;margin:0;display:grid;gap:8px;font-size:14px;color:var(--muted)}
    .seller-list li{display:flex;gap:8px;align-items:flex-start}
    .seller-list li span{font-size:16px;color:#86efac;line-height:1.4}
    #registrationOverlay{position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(34,197,94,.12),transparent 55%),radial-gradient(circle at 80% 30%,rgba(59,130,246,.18),transparent 50%),rgba(4,7,16,.94);display:flex;align-items:center;justify-content:center;padding:20px;z-index:2000;backdrop-filter:blur(6px)}
    #registrationOverlay.hidden{display:none}
    .registration-card{background:linear-gradient(200deg,rgba(9,16,32,.96),rgba(14,28,52,.9));border:1px solid rgba(59,130,246,.3);border-radius:var(--radius);max-width:440px;width:100%;padding:28px;display:grid;gap:16px;box-shadow:0 30px 70px rgba(2,6,23,.75);position:relative;overflow:hidden}
    .registration-card::before{content:"";position:absolute;inset:2px;border-radius:calc(var(--radius) - 2px);border:1px solid rgba(34,197,94,.28);opacity:.6}
    .registration-card::after{content:"";position:absolute;inset:-40% auto auto -40%;width:320px;height:320px;background:radial-gradient(circle,rgba(34,197,94,.3),transparent 60%);filter:blur(40px);opacity:.4;animation:floatOrb 18s ease-in-out infinite}
    .registration-card h2{margin:0}
    .registration-card form{display:grid;gap:12px}
    .checkbox-row{display:flex;gap:10px;align-items:flex-start;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.3);padding:12px;border-radius:10px}
    .checkbox-row input[type="checkbox"]{margin-top:4px}
    .registration-card button{background:linear-gradient(120deg,rgba(34,197,94,.92),rgba(59,130,246,.88));color:#fff;border:none;font-weight:600;cursor:pointer;transition:opacity .2s ease,transform .2s ease,box-shadow .3s ease;box-shadow:0 16px 36px rgba(34,197,94,.35)}
    .registration-card button:hover:not(:disabled){opacity:.95;transform:translateY(-2px);box-shadow:0 20px 42px rgba(59,130,246,.32)}
    .registration-card button:disabled{opacity:.45;cursor:not-allowed;box-shadow:none}
    body.overlay-active{overflow:hidden}
    body.overlay-active header,body.overlay-active main,body.overlay-active .footer{filter:blur(2px);pointer-events:none;user-select:none}
    .country-preview{display:grid;gap:18px}
    .store-menu{background:linear-gradient(200deg,rgba(9,16,28,.92),rgba(10,18,30,.88));border:1px solid rgba(59,130,246,.25);border-radius:18px;padding:22px;display:grid;gap:16px;box-shadow:0 20px 40px rgba(2,6,23,.6)}
    .store-menu h3{margin:0;font-size:18px}
    .store-menu p{margin:0;font-size:14px;color:var(--muted);line-height:1.55}
    .store-menu-list{list-style:none;margin:0;padding:0;display:grid;gap:12px}
    .store-menu-item{display:flex;flex-direction:column;gap:4px;padding:14px 16px;border-radius:12px;background:linear-gradient(160deg,rgba(59,130,246,.12),rgba(34,197,94,.12));border:1px solid rgba(59,130,246,.3);font-weight:600;color:var(--text);transition:transform .3s ease,box-shadow .3s ease}
    .store-menu-item:hover{background:linear-gradient(160deg,rgba(59,130,246,.2),rgba(34,197,94,.18));box-shadow:0 16px 32px rgba(59,130,246,.28);transform:translateY(-4px)}
    .store-menu-label{font-size:15px;letter-spacing:-.01em}
    .store-menu-note{font-size:13px;color:var(--muted);font-weight:500}
  </style>
</head>
<body class="overlay-active">
  <div class="bg-visuals" aria-hidden="true">
    <div class="bg-grid"></div>
    <div class="bg-orb bg-orb--one"></div>
    <div class="bg-orb bg-orb--two"></div>
    <div class="bg-orb bg-orb--three"></div>
  </div>
  <div id="registrationOverlay" role="dialog" aria-modal="true" aria-labelledby="registrationTitle">
    <div class="registration-card">
      <h2 id="registrationTitle">Accès réservé aux membres</h2>
      <p class="muted" style="margin:0">Rejoignez <strong><span data-client-count>0</span></strong> revendeurs Amazon et chasseurs de rabais, puis accédez au catalogue complet.</p>
      <form id="registrationForm">
        <div>
          <label for="fullName">Nom complet</label>
          <input id="fullName" name="fullName" type="text" placeholder="Entrez votre nom" autocomplete="name" required />
        </div>
        <div>
          <label for="email">Courriel</label>
          <input id="email" name="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
        </div>
        <div class="checkbox-row">
          <input id="regulationCheckbox" name="regulation" type="checkbox" required />
          <label for="regulationCheckbox" style="margin:0">Je confirme avoir lu et accepté les réglementations d'utilisation du site.</label>
        </div>
        <button id="registrationSubmit" type="submit" disabled>S'inscrire et accéder</button>
      </form>
    </div>
  </div>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:16px;align-items:center;flex-wrap:wrap">
        <a class="brand" href="index.html">
          <img src="assets/logo.svg" alt="EconoDeal – accélérateur de revendeurs Amazon" />
          <span class="brand-text">
            <span class="brand-title">EconoDeal</span>
            <span class="brand-tagline">Votre hub Amazon</span>
          </span>
        </a>
        <div class="country-toggle country-toggle--header" role="group" aria-label="Choisir le pays">
          <button type="button" class="country-button active" data-country="canada" aria-pressed="true">Canada</button>
          <button type="button" class="country-button" data-country="usa" aria-pressed="false">États-Unis</button>
          <button type="button" class="country-button" data-country="europe" aria-pressed="false">Europe</button>
        </div>
      </div>
      <div class="row" style="gap:12px;align-items:center">
        <a class="nav-button" href="best-deals.html" style="white-space:nowrap">Meilleurs rabais</a>
        <a class="nav-button" href="pricing.html" style="white-space:nowrap">Forfaits / prix</a>
        <a class="nav-button" href="roadmap.html" style="white-space:nowrap">Roadmap / vision</a>
        <span class="header-region" data-exchange-indicator aria-live="polite" aria-label="Taux de change 1 CAD pour 1 CAD">1 CAD = 1 CAD</span>
        <div class="muted" style="white-space:nowrap">Clients inscrits&nbsp;: <span data-client-count>0</span></div>
        <div class="muted">© <span id="year"></span></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section" id="search">
      <h2 style="margin:0 0 10px">Trouver des liquidations pour vos listings Amazon</h2>
      <p class="muted">Les fichiers sont chargés depuis <span class="kbd">data/&lt;magasin&gt;/&lt;ville&gt;.json</span> afin de repérer rapidement les opportunités d'arbitrage.</p>

      <!-- ✅ Les éléments requis existent et leurs IDs correspondent au script -->
      <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px">
        <span class="muted" data-country-label>Pays couvert&nbsp;: Canada · Devise&nbsp;: CAD</span>
      </div>

      <div class="filters" style="margin-top:12px">
        <div>
          <label for="storeSelect">Magasin</label>
          <select id="storeSelect">
            <option value="">(Tous)</option>
          </select>
        </div>
        <div>
          <label for="citySelect">Ville</label>
          <select id="citySelect">
            <option value="">(Toutes)</option>
          </select>
        </div>
        <div>
          <label for="postalInput">Code postal</label>
          <input id="postalInput" name="postal" type="text" inputmode="text" placeholder="Ex. H2X 1Y4" autocomplete="postal-code" />
          <p id="postalHelper" class="field-helper">Entrez les 3 premiers caractères du code postal pour trouver les succursales dans un rayon de 50&nbsp;km (ex. H2X).</p>
        </div>
        <div>
          <label for="discountRange">% de rabais minimal : <span id="discountValue" class="kbd">0%</span></label>
          <input id="discountRange" type="range" min="0" max="90" step="5" value="0" />
        </div>
        <div style="align-self:end">
          <button id="btnClear">Réinitialiser</button>
        </div>
      </div>

      <div id="devError" class="dev-banner"></div>

      <div class="section">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Résultats</h3>
          <div class="muted"><span id="resultCount">0</span> articles</div>
        </div>
        <div id="cards" class="grid" style="margin-top:12px"></div>
      </div>
    </section>

    <section class="amazon-section" id="amazon-sellers">
      <div>
        <h2>Une expérience pensée pour les revendeurs Amazon</h2>
        <p class="amazon-intro">Profitez d'un hub d'approvisionnement bâti pour les opérations FBA et FBM&nbsp;: détectez les liquidations rentables en quelques secondes, sécurisez vos marges et automatisez vos routines de sourcing pour Amazon.ca et Amazon.com.</p>
      </div>
      <div class="seller-metrics">
        <div class="seller-metric">
          <strong>2,4&nbsp;M</strong>
          <span>ASINs surveillés</span>
          <p>Cartographie dynamique des catalogues Amazon.ca, Amazon.com et Amazon EU.</p>
        </div>
        <div class="seller-metric">
          <strong>18&nbsp;s</strong>
          <span>Détection moyenne</span>
          <p>Latence entre l'import d'un rabais et l'alerte envoyée à votre équipe.</p>
        </div>
        <div class="seller-metric">
          <strong>+32&nbsp;%</strong>
          <span>Marge récupérée</span>
          <p>Gain médian observé chez les revendeurs utilisant nos scénarios IA.</p>
        </div>
      </div>
      <div class="seller-grid">
        <article class="seller-card">
          <div class="seller-icon" aria-hidden="true">🚀</div>
          <h3>Onboarding FBA simplifié</h3>
          <p>Des modèles prêts à l'emploi pour calculer les frais FBA, estimer la rotation et synchroniser vos listes Amazon sans feuille de calcul complexe.</p>
        </article>
        <article class="seller-card">
          <div class="seller-icon" aria-hidden="true">📦</div>
          <h3>Veille des stocks multi-fournisseurs</h3>
          <p>Combinez les inventaires de Best Buy, Walmart, Canadian Tire et plus afin de détecter les écarts de prix exploitables avant vos concurrents Amazon.</p>
        </article>
        <article class="seller-card">
          <div class="seller-icon" aria-hidden="true">🤝</div>
          <h3>Communauté dédiée</h3>
          <p>Accédez à un salon privé de revendeurs Amazon, partagez vos stratégies de repricing et bénéficiez de comparatifs de produits validés par la communauté.</p>
        </article>
        <article class="seller-card">
          <div class="seller-icon" aria-hidden="true">⚙️</div>
          <h3>Automations prêtes à lancer</h3>
          <ul class="seller-list">
            <li><span aria-hidden="true">✔</span>Alertes quand la Buy Box chute sous votre cible.</li>
            <li><span aria-hidden="true">✔</span>Exports compatibles Seller Central et outils d'analyse FBA.</li>
            <li><span aria-hidden="true">✔</span>Suggestions IA pour reconditionner ou arbitrer selon la saison.</li>
          </ul>
        </article>
      </div>
    </section>

    <section class="section" id="pricing" style="padding-top:10px">
      <h2 style="margin:0 0 10px">Forfaits adaptés à vos besoins</h2>
      <p class="muted" style="max-width:620px">Choisissez l'option qui correspond le mieux à votre façon de surveiller les rabais, d'alimenter vos listings Amazon et de sécuriser vos marges. Chaque forfait inclut une période d'essai de 7 jours.</p>
      <div class="pricing-grid">
        <article class="pricing-card">
          <div class="pricing-tag">Essentiel</div>
          <h4>Accès de base</h4>
          <div class="pricing-price">9,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Accès aux liquidations populaires prêtes pour Amazon</li>
            <li>3 alertes courriel par semaine</li>
            <li>Historique de prix sur 30 jours</li>
          </ul>
        </article>
        <article class="pricing-card pricing-highlight">
          <div class="pricing-tag">Le plus populaire</div>
          <h4>Forfait Avancé</h4>
          <div class="pricing-price">19,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Accès illimité au catalogue optimisé Amazon</li>
            <li>Alertes personnalisées en temps réel</li>
            <li>Exports Seller Central et listes partagées avec votre équipe</li>
          </ul>
        </article>
        <article class="pricing-card">
          <div class="pricing-tag">Premium</div>
          <h4>Analyse IA complète</h4>
          <div class="pricing-price">29,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Alertes illimitées multicanal</li>
            <li>Analyse des prix assistée par IA dédiée à Amazon</li>
            <li>Prévisions de tendances du marché et simulation FBA</li>
          </ul>
        </article>
      </div>
    </section>

    <section class="section" id="roadmap" style="padding-top:0">
      <h2 style="margin:0 0 10px">Notre feuille de route</h2>
      <p class="muted" style="max-width:640px">Une vision triennale pour propulser EconoDeal sur la scène internationale, avec une intégration progressive de l'intelligence artificielle au cœur de nos services.</p>
      <div class="roadmap">
        <div class="roadmap-grid">
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 1</strong> Canada</div>
            <ul>
              <li>Consolider la couverture des détaillants nationaux.</li>
              <li>Optimiser les alertes de rabais en temps réel.</li>
              <li>Lancer des tableaux de bord régionaux bilingues.</li>
            </ul>
          </article>
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 2</strong> États-Unis</div>
            <ul>
              <li>Élargir le catalogue aux grandes bannières américaines.</li>
              <li>Déployer la surveillance des stocks multi-états.</li>
              <li>Introduire l'analyse prédictive des tendances d'achat.</li>
            </ul>
          </article>
          <article class="roadmap-card roadmap-ai">
            <div class="roadmap-year"><strong>Année 3</strong> Europe</div>
            <ul>
              <li>Localiser l'expérience pour les principaux marchés européens.</li>
              <li>Activer un moteur de recommandations IA multilingue.</li>
              <li>Automatiser les stratégies de prix grâce à l'apprentissage continu.</li>
            </ul>
          </article>
        </div>
      </div>
    </section>
  </main>

  <div class="container footer">
    © <span id="yearFooter"></span> EconoDeal · Tous droits réservés
  </div>

  <script>
  // === Initialisation sûre ===
  document.addEventListener('DOMContentLoaded', async () => {
    const overlay = document.getElementById('registrationOverlay');
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('registrationSubmit');
    const regulationCheckbox = document.getElementById('regulationCheckbox');
    const clientCountDisplays = Array.from(document.querySelectorAll('[data-client-count]'));
    function parseJson(value){
      if(!value) return null;
      try{
        return JSON.parse(value);
      }catch(err){
        console.warn('Impossible de lire les données existantes', err);
        return null;
      }
    }

    function safeGet(key){
      try{
        return localStorage.getItem(key);
      }catch(err){
        console.warn('Stockage local indisponible', err);
        return null;
      }
    }

    function safeSet(key, value){
      try{
        localStorage.setItem(key, value);
      }catch(err){
        console.warn('Impossible d\'enregistrer les données', err);
      }
    }

    function cleanText(value){
      return typeof value === 'string' ? value.trim() : '';
    }

    function getRegistrations(){
      const parsed = parseJson(safeGet('econodealRegistrations'));
      if(!Array.isArray(parsed)) return [];
      return parsed
        .filter(item => item && typeof item === 'object')
        .map(item => ({
          name: cleanText(item.name),
          email: cleanText(item.email).toLowerCase(),
          registeredAt: cleanText(item.registeredAt)
        }))
        .filter(item => item.email);
    }

    function saveRegistrations(items){
      safeSet('econodealRegistrations', JSON.stringify(items));
    }

    function upsertRegistration(entry){
      const collection = getRegistrations();
      const email = cleanText(entry.email).toLowerCase();
      if(!email) return;

      const normalized = {
        name: cleanText(entry.name),
        email,
        registeredAt: cleanText(entry.registeredAt)
      };

      const existingIndex = collection.findIndex(item => item.email === email);
      if(existingIndex >= 0){
        collection[existingIndex] = {
          ...collection[existingIndex],
          ...normalized
        };
      }else{
        collection.push(normalized);
      }

      saveRegistrations(collection);
    }

    function parseCount(value){
      const parsed = parseInt(value ?? '0', 10);
      return Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
    }

    function getClientCount(){
      return parseCount(safeGet('econodealClientCount'));
    }

    function setClientCount(value){
      safeSet('econodealClientCount', String(Math.max(0, value)));
    }

    function updateClientCountDisplays(){
      const formatter = new Intl.NumberFormat('fr-CA');
      const count = getClientCount();
      clientCountDisplays.forEach(el => {
        el.textContent = formatter.format(count);
      });
    }

    function hideOverlay(){
      if(!overlay) return;
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('overlay-active');
    }

    function showOverlay(){
      if(!overlay) return;
      overlay.classList.remove('hidden');
      overlay.removeAttribute('aria-hidden');
      document.body.classList.add('overlay-active');
      updateClientCountDisplays();
    }

    updateClientCountDisplays();

    const alreadyRegistered = safeGet('econodealClientRegistered') === 'true';
    if(alreadyRegistered){
      hideOverlay();
    }else{
      showOverlay();
    }

    if(submitBtn && regulationCheckbox){
      submitBtn.disabled = !regulationCheckbox.checked;
      regulationCheckbox.addEventListener('change', () => {
        submitBtn.disabled = !regulationCheckbox.checked;
      });
    }

    if(form){
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        if(!form.reportValidity()) return;

        const wasRegistered = safeGet('econodealClientRegistered') === 'true';
        if(!wasRegistered){
          const current = getClientCount();
          setClientCount(current + 1);
        }

        const payload = {
          name: (form.fullName?.value ?? '').trim(),
          email: (form.email?.value ?? '').trim(),
          consent: true,
          registeredAt: new Date().toISOString()
        };

        safeSet('econodealUser', JSON.stringify(payload));
        upsertRegistration(payload);
        safeSet('econodealClientRegistered', 'true');
        updateClientCountDisplays();
        hideOverlay();
      });
    }

    function baseBranches(){
      return [
        {label:'Montréal', slug:'montreal', city:'Montréal'},
        {label:'Laval', slug:'laval', city:'Laval'},
        {label:'Saint-Jérôme', slug:'saint-jerome', city:'Saint-Jérôme'}
      ];
    }

    function fullBestBuyBranches(){
      return [
        {label:'En ligne (Canada)', slug:'en-ligne', city:'En ligne', hasData:true},
        {label:'Anjou (1)', slug:'anjou', city:'Anjou', hasData:false},
        {label:'Baie Comeau (1)', slug:'baie-comeau', city:'Baie-Comeau', hasData:false},
        {label:'Beloeil (1)', slug:'beloeil', city:'Beloeil', hasData:false},
        {label:'Brossard (1)', slug:'brossard', city:'Brossard', hasData:false},
        {label:'Chomedey (2)', slug:'chomedey', city:'Chomedey', hasData:false},
        {label:'Chateauguay (1)', slug:'chateauguay', city:'Chateauguay', hasData:false},
        {label:'Chicoutimi (1)', slug:'chicoutimi', city:'Chicoutimi', hasData:false},
        {label:'Drummondville (1)', slug:'drummondville', city:'Drummondville', hasData:false},
        {label:'Gatineau (3)', slug:'gatineau', city:'Gatineau', hasData:false},
        {label:'Granby (1)', slug:'granby', city:'Granby', hasData:false},
        {label:'Joliette (1)', slug:'joliette', city:'Joliette', hasData:false},
        {label:'LaSalle (1)', slug:'lasalle', city:'LaSalle', hasData:false},
        {label:'Laval (2)', slug:'laval-best-buy', city:'Laval', hasData:false},
        {label:'Longueuil (1)', slug:'longueuil', city:'Longueuil', hasData:false},
        {label:'Mascouche (1)', slug:'mascouche', city:'Mascouche', hasData:false},
        {label:'Montmagny (1)', slug:'montmagny', city:'Montmagny', hasData:false},
        {label:'Montreal (2)', slug:'montreal-best-buy', city:'Montréal', hasData:false},
        {label:'Pointe-Claire (2)', slug:'pointe-claire', city:'Pointe-Claire', hasData:false},
        {label:'Quebec (4)', slug:'quebec', city:'Québec', hasData:false},
        {label:'Rawdon (1)', slug:'rawdon', city:'Rawdon', hasData:false},
        {label:'Repentigny (2)', slug:'repentigny', city:'Repentigny', hasData:false},
        {label:'Rimouski (1)', slug:'rimouski', city:'Rimouski', hasData:false},
        {label:'Riviere Du Loup (1)', slug:'riviere-du-loup', city:'Rivière-du-Loup', hasData:false},
        {label:'Rosemere (1)', slug:'rosemere', city:'Rosemère', hasData:false},
        {label:'Rouyn Noranda (1)', slug:'rouyn-noranda', city:'Rouyn-Noranda', hasData:false},
        {label:'Saint-Eustache (1)', slug:'saint-eustache', city:'Saint-Eustache', hasData:false},
        {label:'Saint-Hyacinthe (1)', slug:'saint-hyacinthe', city:'Saint-Hyacinthe', hasData:false},
        {label:'Saint-Jean-sur-Richelieu (1)', slug:'saint-jean-sur-richelieu', city:'Saint-Jean-sur-Richelieu', hasData:false},
        {label:'Saint-Jerome (1)', slug:'saint-jerome', city:'Saint-Jérôme', hasData:false},
        {label:'Sainte-Marie (1)', slug:'sainte-marie', city:'Sainte-Marie', hasData:false},
        {label:'Sept Iles (1)', slug:'sept-iles', city:'Sept-Îles', hasData:false},
        {label:'Sherbrooke (1)', slug:'sherbrooke', city:'Sherbrooke', hasData:false},
        {label:'St Georges (1)', slug:'st-georges', city:'Saint-Georges', hasData:false},
        {label:'St Hyacinthe (1)', slug:'st-hyacinthe', city:'Saint-Hyacinthe', hasData:false},
        {label:'St Jerome (1)', slug:'st-jerome', city:'Saint-Jérôme', hasData:false},
        {label:'St-Bruno-de Montarville (1)', slug:'st-bruno-de-montarville', city:'Saint-Bruno-de-Montarville', hasData:false},
        {label:'Terrebonne (1)', slug:'terrebonne', city:'Terrebonne', hasData:false},
        {label:'Thetford Mines (1)', slug:'thetford-mines', city:'Thetford Mines', hasData:false},
        {label:'Trois-Rivieres (1)', slug:'trois-rivieres', city:'Trois-Rivières', hasData:false},
        {label:"Val-d'Or (1)", slug:'val-d-or', city:"Val-d'Or", hasData:false},
        {label:'Vaudreuil-Dorion (1)', slug:'vaudreuil-dorion', city:'Vaudreuil-Dorion', hasData:false},
        {label:'Victoriaville (1)', slug:'victoriaville', city:'Victoriaville', hasData:false},
        {label:'Ville Mont Royal (1)', slug:'ville-mont-royal', city:'Mont-Royal', hasData:false}
      ];
    }

    const DEFAULT_BRANCH_SLUGS = new Set([
      ...baseBranches().map(branch => branch.slug),
      'en-ligne',
      'montreal-best-buy',
      'laval-best-buy'
    ]);

    const WALMART_QUEBEC_BRANCHES = [
      {label: 'Alma — Walmart #10036849', slug: 'alma-10036849', city: 'Alma', address: '1755 avenue du Pont Sud', hasData: false},
      {label: 'Baie-Comeau — Walmart #10036620', slug: 'baie-comeau-10036620', city: 'Baie-Comeau', address: '630 boul. Laflèche', hasData: false},
      {label: 'Beauport — Walmart #10036820', slug: 'beauport-10036820', city: 'Beauport', address: '224 boul. Joseph-Casavant', hasData: false},
      {label: 'Blainville — Walmart Supercentre #1185', slug: 'blainville-1185', city: 'Blainville', address: '1333 boulevard Michèle-Bohec', hasData: false},
      {label: 'Brossard — Walmart #10036625', slug: 'brossard-10036625', city: 'Brossard', address: '9000 boul. Leduc', hasData: false},
      {label: 'Candiac — Walmart', slug: 'candiac-201-rue-de-strasbourg', city: 'Candiac', address: '201 rue de Strasbourg', hasData: false},
      {label: 'Cap-de-la-Madeleine — Walmart #10036632', slug: 'cap-de-la-madeleine-10036632', city: 'Cap-de-la-Madeleine', address: 'rue Barkoff', hasData: false},
      {label: 'Châteauguay — Walmart Supercentre #1132', slug: 'chateauguay-1132', city: 'Châteauguay', address: '250 boul. Brisebois', hasData: false},
      {label: 'Chicoutimi — Walmart #10036635', slug: 'chicoutimi-10036635', city: 'Chicoutimi', address: '1451 boul. Talbot', hasData: false},
      {label: 'Cowansville — Walmart #10036857', slug: 'cowansville-10036857', city: 'Cowansville', address: '1770 rue du Sud', hasData: false},
      {label: 'Drummondville — Walmart #10036641', slug: 'drummondville-10036641', city: 'Drummondville', address: '1205 boul. René-Lévesque', hasData: false},
      {label: 'Gatineau — Walmart #10036601', slug: 'gatineau-10036601', city: 'Gatineau', address: '51 boul. de la Gappe', hasData: false},
      {label: 'Gatineau — Walmart #10036743', slug: 'gatineau-10036743', city: 'Gatineau', address: '640 boul. Maloney Ouest', hasData: false},
      {label: 'Granby — Walmart #10036653', slug: 'granby-10036653', city: 'Granby', address: '75 rue Simonds Nord', hasData: false},
      {label: 'Hull — Walmart #10036761', slug: 'hull-10036761', city: 'Hull', address: '35 boul. du Plateau', hasData: false},
      {label: 'Joliette — Walmart #10036657', slug: 'joliette-10036657', city: 'Joliette', address: '1505 boul. Firestone', hasData: false},
      {label: 'Kirkland — Walmart #10036662', slug: 'kirkland-10036662', city: 'Kirkland', address: '17 000 route Transcanadienne', hasData: false},
      {label: 'La Pocatière — Walmart', slug: 'la-pocatiere-160-qc-230', city: 'La Pocatière', address: '160 QC-230', hasData: false},
      {label: 'Lac-Mégantic — Walmart #10036547', slug: 'lac-megantic-10036547', city: 'Lac-Mégantic', address: '3130 rue Laval', hasData: false},
      {label: 'Lachenaie — Walmart #10036600', slug: 'lachenaie-10036600', city: 'Lachenaie', address: '1001 rue des Migrateurs', hasData: false},
      {label: 'Lachute — Walmart #10036750', slug: 'lachute-10036750', city: 'Lachute', address: '480 rue Bethany', hasData: false},
      {label: 'LaSalle — Walmart #10036664', slug: 'lasalle-10036664', city: 'LaSalle', address: '6797 boul. Newman', hasData: false},
      {label: 'Laval — Walmart Supercentre #10036665', slug: 'laval', city: 'Laval', address: '2075 boul. Chomedey', hasData: true},
      {label: 'Laval Est — Walmart #10036558', slug: 'laval-est-10036558', city: 'Laval Est', address: '5205 boul. de Val-des-Brises', hasData: false},
      {label: 'Lévis — Walmart #3148', slug: 'levis-3148', city: 'Lévis', address: '1200 boul. Alphonse-Desjardins', hasData: false},
      {label: 'Longueuil — Walmart #1167', slug: 'longueuil-1167', city: 'Longueuil', address: '2877 chemin de Chambly', hasData: false},
      {label: 'Magog — Walmart #10036592', slug: 'magog-10036592', city: 'Magog', address: '1935 rue Sherbrooke', hasData: false},
      {label: 'Mascouche — Walmart #10036767', slug: 'mascouche-10036767', city: 'Mascouche', address: '155 montée Masson', hasData: false},
      {label: 'Matane — Walmart #10036551', slug: 'matane-10036551', city: 'Matane', address: '150 rue Piuze', hasData: false},
      {label: 'Montréal — Walmart #10036783', slug: 'montreal', city: 'Montréal', address: '5400 rue Jean-Talon Ouest', hasData: true},
      {label: 'Montréal-Nord — Walmart #10036828', slug: 'montreal-nord-10036828', city: 'Montréal-Nord', address: '6140 boul. Henri-Bourassa Est', hasData: false},
      {label: 'Québec — Walmart #10036692', slug: 'quebec-10036692', city: 'Québec', address: '1700 boul. Lebourgneuf', hasData: false},
      {label: 'Repentigny — Walmart #10036697', slug: 'repentigny-10036697', city: 'Repentigny', address: '100 boul. Brien', hasData: false},
      {label: 'Rimouski — Walmart #10036809', slug: 'rimouski-10036809', city: 'Rimouski', address: '415 montée Industrielle-et-Commerciale', hasData: false},
      {label: 'Rivière-du-Loup — Walmart #10036827', slug: 'riviere-du-loup-10036827', city: 'Rivière-du-Loup', address: '100 rue des Cerisiers', hasData: false},
      {label: 'Rosemère — Walmart #10036698', slug: 'rosemere-10036698', city: 'Rosemère', address: '401 boul. Curé-Labelle', hasData: false},
      {label: 'Rouyn-Noranda — Walmart #10036754', slug: 'rouyn-noranda-10036754', city: 'Rouyn-Noranda', address: '275 boul. Rideau', hasData: false},
      {label: 'Saint-Bruno-de-Montarville — Walmart #10036758', slug: 'saint-bruno-de-montarville-10036758', city: 'Saint-Bruno-de-Montarville', address: '1475 boul. Saint-Bruno', hasData: false},
      {label: 'Saint-Constant — Walmart #10036817', slug: 'saint-constant-10036817', city: 'Saint-Constant', address: '500 voie de desserte de la route 132', hasData: false},
      {label: 'Saint-Eustache — Walmart #10036707', slug: 'saint-eustache-10036707', city: 'Saint-Eustache', address: '764 boul. Arthur-Sauvé', hasData: false},
      {label: 'Saint-Georges — Walmart #10036565', slug: 'saint-georges-10036565', city: 'Saint-Georges', address: '750 107e rue', hasData: false},
      {label: 'Saint-Hyacinthe — Walmart #10036755', slug: 'saint-hyacinthe-10036755', city: 'Saint-Hyacinthe', address: '5950 rue Martineau', hasData: false},
      {label: 'Saint-Jean-sur-Richelieu — Walmart #10036708', slug: 'saint-jean-sur-richelieu-10036708', city: 'Saint-Jean-sur-Richelieu', address: '100 rue Omer-Marcil', hasData: false},
      {label: 'Saint-Jérôme — Walmart #10036803', slug: 'saint-jerome', city: 'Saint-Jérôme', address: '1030 boul. du Grand-Héron', hasData: true},
      {label: 'Saint-Léonard — Walmart #10036712', slug: 'saint-leonard-10036712', city: 'Saint-Léonard', address: '7445 boul. Langelier', hasData: false},
      {label: 'Saint-Romuald — Walmart #10036569', slug: 'saint-romuald-10036569', city: 'Saint-Romuald', address: '700 rue de la Concorde', hasData: false},
      {label: 'Sainte-Agathe-des-Monts — Walmart #10036548', slug: 'sainte-agathe-des-monts-10036548', city: 'Sainte-Agathe-des-Monts', address: '400 rue Laverdure', hasData: false},
      {label: 'Sainte-Foy — Walmart #10036764', slug: 'sainte-foy-10036764', city: 'Sainte-Foy', address: '1470 rue Jules-Verne', hasData: false},
      {label: 'Salaberry-de-Valleyfield — Walmart #10036815', slug: 'salaberry-de-valleyfield-10036815', city: 'Salaberry-de-Valleyfield', address: '2050 boul. Monseigneur-Langlois', hasData: false},
      {label: 'Sept-Îles — Walmart #10036703', slug: 'sept-iles-10036703', city: 'Sept-Îles', address: '1005 boul. Laure', hasData: false},
      {label: 'Shawinigan — Walmart #10036821', slug: 'shawinigan-10036821', city: 'Shawinigan', address: '1600 boul. Royal', hasData: false},
      {label: 'Sherbrooke — Walmart #10036704', slug: 'sherbrooke-10036704', city: 'Sherbrooke', address: '4050 boul. Josaphat-Rancourt', hasData: false},
      {label: 'Sainte-Dorothée — Walmart #10036802', slug: 'sainte-dorothee-10036802', city: 'Sainte-Dorothée', address: '700 autoroute Chomedey Ouest', hasData: false},
      {label: 'Thetford Mines — Walmart #10036853', slug: 'thetford-mines-10036853', city: 'Thetford Mines', address: '1025 boul. Frontenac Est', hasData: false},
      {label: 'Trois-Rivières — Walmart #10036726', slug: 'trois-rivieres-10036726', city: 'Trois-Rivières', address: '4520 boul. Royal', hasData: false},
      {label: "Val-d'Or — Walmart #10036757", slug: 'val-d-or-10036757', city: "Val-d'Or", address: '1855 3e avenue Ouest', hasData: false},
      {label: 'Vaudreuil-Dorion — Walmart #10036578', slug: 'vaudreuil-dorion-10036578', city: 'Vaudreuil-Dorion', address: '3050 boul. de la Gare', hasData: false},
      {label: 'Victoriaville — Walmart #10036836', slug: 'victoriaville-10036836', city: 'Victoriaville', address: '110 boul. Arthabaska Ouest', hasData: false}
    ];

    const STORES = [
      {label:'Best Buy', slug:'best-buy', branches: fullBestBuyBranches()},
      {label:'Home Depot', slug:'home-depot', branches: baseBranches()},
      {label:'Walmart', slug:'walmart', branches: WALMART_QUEBEC_BRANCHES},
      {label:'Canadian Tire', slug:'canadian-tire', branches: baseBranches()},
      {label:'Rona', slug:'rona', branches: baseBranches()},
      {label:'Patrick Morin', slug:'patrick-morin', branches: baseBranches()},
      {label:'Sporting Life', slug:'sporting-life', branches: baseBranches()}
    ];

    function formatBranchCoverage(branches){
      const count = Array.isArray(branches) ? branches.length : 0;
      if(count <= 0) return '';
      const suffix = count > 1 ? 's' : '';
      return `${count} succursale${suffix} suivie${suffix}`;
    }

    const CANADA_STORE_MENU = STORES.map(store => ({
      label: store.label,
      description: formatBranchCoverage(store.branches)
    }));

    const USA_STORE_MENU = [
      {label:'Amazon Warehouse', description:'Lots de retours et inventaires reconditionnés'},
      {label:'Best Buy USA', description:'Électronique, électroménagers et gaming'},
      {label:'Home Depot US', description:'Amélioration résidentielle et outils'},
      {label:'Walmart US', description:'Grande distribution et épicerie sèche'},
      {label:'Target', description:'Lifestyle, maison et exclusivités marque privée'},
      {label:'Lowe’s', description:'Matériaux de rénovation et jardinage'},
      {label:'Costco Wholesale', description:'Lots en gros propices au FBA'},
      {label:'Sam’s Club', description:'Opportunités en vrac pour la revente'},
      {label:'Kohl’s', description:'Mode, maison et articles saisonniers'},
      {label:"BJ's Wholesale Club", description:'Inventaire régional à forte rotation'}
    ];

    const POSTAL_DIRECTORY = [
      {
        branchSlug:'montreal',
        cityLabel:'Montréal (Île)',
        prefixes:[
          'H1A','H1B','H1C','H1E','H1G','H1H','H1J','H1K','H1L','H1M','H1N','H1P','H1R','H1S','H1T','H1V','H1W','H1X','H1Y','H1Z',
          'H2A','H2B','H2C','H2E','H2G','H2H','H2J','H2K','H2L','H2M','H2N','H2P','H2R','H2S','H2T','H2V','H2W','H2X','H2Y','H2Z',
          'H3A','H3B','H3C','H3E','H3G','H3H','H3J','H3K','H3L','H3M','H3N','H3R','H3S','H3T','H3V','H3W','H3X','H3Y','H3Z',
          'H4A','H4B','H4C','H4E','H4G','H4H','H4J','H4K','H4L','H4M','H4N','H4P','H4R','H4S','H4T','H4V','H4W','H4X',
          'H8N','H8P','H8R','H8S','H8T','H8Y','H8Z','H9A','H9B','H9C','H9E','H9G','H9H','H9J','H9K','H9P','H9R','H9S','H9W','H9X'
        ]
      },
      {
        branchSlug:'laval',
        cityLabel:'Laval',
        prefixes:[
          'H7A','H7B','H7C','H7E','H7G','H7H','H7J','H7K','H7L','H7M','H7N','H7P','H7R','H7S','H7T','H7V','H7W','H7X','H7Y','H7Z',
          'H8N','H8P','H8R','H8T','H8Y'
        ]
      },
      {
        branchSlug:'saint-jerome',
        cityLabel:'Saint-Jérôme',
        prefixes:['J5L','J7Y','J7Z','J8A']
      }
    ];

    const storeSelect = document.getElementById('storeSelect');
    const citySelect  = document.getElementById('citySelect');
    const range       = document.getElementById('discountRange');
    const rangeLabel  = document.getElementById('discountValue');
    const cardsEl     = document.getElementById('cards');
    const countEl     = document.getElementById('resultCount');
    const btnClear    = document.getElementById('btnClear');
    const devError    = document.getElementById('devError');
    const postalInput = document.getElementById('postalInput');
    const postalHelper = document.getElementById('postalHelper');
    const countryButtons = Array.from(document.querySelectorAll('.country-button[data-country]'));
    const countryLabel = document.querySelector('[data-country-label]');
    const exchangeIndicator = document.querySelector('[data-exchange-indicator]');

    const DEFAULT_POSTAL_MESSAGE = 'Entrez les 3 premiers caractères du code postal pour trouver les succursales dans un rayon de 50 km (ex. H2X).';
    const BASE_CURRENCY = { code:'CAD', locale:'fr-CA' };
    // currency.cadToLocalRate indique la conversion d'un dollar canadien vers la devise locale.
    const COUNTRY_CONFIG = {
      canada: {
        titleSuffix: 'Canada',
        postalMessage: DEFAULT_POSTAL_MESSAGE,
        emptyNotice: 'Sélectionnez un magasin pour afficher les liquidations canadiennes disponibles en ce moment.',
        storeMenuTitle: 'Magasins actuellement couverts',
        storeMenuDescription: 'Même liste que le sélecteur de magasins disponibles ci-dessus.',
        storeMenu: CANADA_STORE_MENU,
        currency: {
          code: 'CAD',
          locale: 'fr-CA',
          cadToLocalRate: 1
        },
        amazonDomain: 'www.amazon.ca'
      },
      usa: {
        titleSuffix: 'États-Unis',
        postalMessage: 'Les filtres seront activés dès le lancement de la plateforme aux États-Unis.',
        emptyNotice: 'Nous finalisons notre catalogue américain. Revenez bientôt pour découvrir les meilleures aubaines aux États-Unis.',
        storeMenuTitle: 'Magasins couverts au lancement américain',
        storeMenuDescription: 'Ces enseignes seront intégrées à notre radar de liquidations pour les États-Unis dès l’ouverture officielle.',
        storeMenu: USA_STORE_MENU,
        currency: {
          code: 'USD',
          locale: 'en-US',
          cadToLocalRate: 0.74
        },
        amazonDomain: 'www.amazon.com'
      },
      europe: {
        titleSuffix: 'Europe',
        postalMessage: 'Les fonctions de recherche seront disponibles lors du déploiement européen.',
        emptyNotice: 'La couverture européenne est en préparation. Abonnez-vous pour être informé de l’ouverture officielle.',
        currency: {
          code: 'EUR',
          locale: 'fr-FR',
          cadToLocalRate: 0.68
        },
        amazonDomain: 'www.amazon.fr'
      }
    };
    let activeCountry = 'canada';
    let savedFilters = null;
    const DEFAULT_FILTERS = Object.freeze({
      store: 'walmart',
      city: 'saint-jerome',
      discount: '0'
    });

    const EXCHANGE_FORMATTER = new Intl.NumberFormat('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2});

    function getCountryConfig(country){
      return COUNTRY_CONFIG[country] ?? COUNTRY_CONFIG.canada;
    }

    function getCurrencySettings(country){
      const fallback = COUNTRY_CONFIG.canada?.currency ?? { code: BASE_CURRENCY.code, locale: BASE_CURRENCY.locale, cadToLocalRate: 1 };
      const config = COUNTRY_CONFIG[country];
      if(config && config.currency){
        return {...fallback, ...config.currency};
      }
      return fallback;
    }

    function formatExchange(baseCode, targetCode, rate){
      const normalizedRate = Number.isFinite(rate) && rate > 0 ? rate : 1;
      const direct = EXCHANGE_FORMATTER.format(normalizedRate);
      const inverse = normalizedRate > 0 ? EXCHANGE_FORMATTER.format(1 / normalizedRate) : null;
      const baseText = `1 ${baseCode} ≈ ${direct} ${targetCode}`;
      const inverseText = inverse ? `1 ${targetCode} ≈ ${inverse} ${baseCode}` : '';
      return { baseText, inverseText, directValue: direct, inverseValue: inverse };
    }

    function updateExchangeIndicator(){
      if(!exchangeIndicator) return;
      const settings = getCurrencySettings(activeCountry);
      const baseCode = BASE_CURRENCY.code;
      const targetCode = settings.code || baseCode;
      const rate = Number(settings.cadToLocalRate);
      const normalizedRate = Number.isFinite(rate) && rate > 0 ? rate : 1;
      if(activeCountry === 'canada'){
        const segments = [];
        const ariaSegments = [];
        const usdSettings = getCurrencySettings('usa');
        const usdCode = usdSettings.code || 'USD';
        const usdRate = Number(usdSettings.cadToLocalRate);
        if(usdCode && usdCode !== baseCode && Number.isFinite(usdRate) && usdRate > 0){
          const { baseText, inverseText, directValue, inverseValue } = formatExchange(baseCode, usdCode, usdRate);
          segments.push(baseText);
          if(inverseText){
            segments.push(inverseText);
          }
          ariaSegments.push(`1 ${baseCode} pour environ ${directValue} ${usdCode}`);
          if(inverseText && inverseValue){
            ariaSegments.push(`1 ${usdCode} pour environ ${inverseValue} ${baseCode}`);
          }
        }
        if(segments.length === 0){
          segments.push(`1 ${baseCode} = 1 ${baseCode}`);
          ariaSegments.push(`1 ${baseCode} pour 1 ${baseCode}`);
        }
        exchangeIndicator.textContent = segments.join(' · ');
        exchangeIndicator.setAttribute('aria-label', `Taux de change ${ariaSegments.join(' et ')}`);
        return;
      }
      if(Math.abs(normalizedRate - 1) < 1e-6){
        exchangeIndicator.textContent = `1 ${baseCode} = 1 ${baseCode}`;
        exchangeIndicator.setAttribute('aria-label', `Taux de change 1 ${baseCode} pour 1 ${baseCode}`);
        return;
      }
      const { baseText, inverseText } = formatExchange(baseCode, targetCode, normalizedRate);
      const combined = inverseText ? `${baseText} · ${inverseText}` : baseText;
      exchangeIndicator.textContent = combined;
      const ariaText = inverseText ? `${baseText} et ${inverseText}` : baseText;
      exchangeIndicator.setAttribute('aria-label', `Taux de change ${ariaText}`);
    }

    function updateCountryMeta(){
      const config = getCountryConfig(activeCountry);
      document.title = `EconoDeal — ${config.titleSuffix}`;
      if(countryLabel){
        const currency = getCurrencySettings(activeCountry);
        const currencyPart = currency?.code ? ` · Devise : ${currency.code}` : '';
        countryLabel.textContent = `Pays couvert : ${config.titleSuffix}${currencyPart}`;
      }
      updateExchangeIndicator();
    }

    function updateCountryButtons(){
      for(const button of countryButtons){
        const isActive = button.dataset.country === activeCountry;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      }
    }

    function setFiltersDisabled(disabled){
      const elements = [storeSelect, citySelect, postalInput, range, btnClear];
      for(const el of elements){
        if(!el) continue;
        if(disabled){
          el.setAttribute('disabled', 'disabled');
        }else{
          el.removeAttribute('disabled');
        }
        if(el !== btnClear){
          if(disabled){
            el.setAttribute('aria-disabled', 'true');
          }else{
            el.removeAttribute('aria-disabled');
          }
        }
      }
      if(btnClear){
        if(disabled){
          btnClear.setAttribute('aria-disabled', 'true');
        }else{
          btnClear.removeAttribute('aria-disabled');
        }
      }
    }

    function populateStoreSelect(country){
      if(!storeSelect) return;
      const options = ['<option value="">(Tous)</option>'];
      if(country === 'canada'){
        for(const store of STORES){
          const label = store?.label;
          const value = store?.slug;
          if(!label || !value) continue;
          const option = `<option value="${value}">${label}</option>`;
          options.push(option);
        }
      }else{
        const config = getCountryConfig(country);
        const menu = Array.isArray(config?.storeMenu) ? config.storeMenu : [];
        for(const entry of menu){
          const label = entry?.label;
          if(!label) continue;
          const value = entry?.slug || slugify(label || '');
          const option = `<option value="${value}" disabled>${label}</option>`;
          options.push(option);
        }
      }
      storeSelect.innerHTML = options.join('');
    }

    function setCountry(country){
      const isKnown = Object.prototype.hasOwnProperty.call(COUNTRY_CONFIG, country);
      const next = isKnown ? country : 'canada';
      if(next === activeCountry) return;

      if(activeCountry === 'canada'){
        savedFilters = {
          store: storeSelect?.value || '',
          city: citySelect?.value || '',
          discount: range?.value || '0'
        };
      }

      activeCountry = next;
      populateStoreSelect(activeCountry);
      updateCountryButtons();
      updateCountryMeta();

      if(activeCountry !== 'canada'){
        const config = getCountryConfig(activeCountry);
        setFiltersDisabled(true);
        resetPostalFilter();
        postalBranchSlugs = null;
        if(storeSelect){
          storeSelect.value = '';
          const hasPreviewMenu = Array.isArray(config?.storeMenu) && config.storeMenu.some(item => item && item.label);
          if(hasPreviewMenu){
            storeSelect.removeAttribute('disabled');
            storeSelect.setAttribute('aria-disabled', 'true');
            storeSelect.dataset.preview = 'true';
          }
        }
        setCityOptions('', false);
        if(citySelect){
          citySelect.value = '';
        }
        if(range){
          range.value = 0;
        }
        updatePostalHelper(config.postalMessage, false);
        deals.length = 0;
        render();
        return;
      }

      setFiltersDisabled(false);
      if(storeSelect){
        delete storeSelect.dataset.preview;
      }
      const filters = savedFilters ?? DEFAULT_FILTERS;
      const initialStore = getStoreByIdentifier(filters.store);
      const storeValue = initialStore?.slug || '';
      if(storeSelect){
        storeSelect.value = storeValue;
      }
      setCityOptions(storeValue, false);
      if(citySelect){
        const options = Array.from(citySelect.options || []);
        const hasCity = options.some(option => option.value === (filters.city || ''));
        citySelect.value = hasCity ? (filters.city || '') : '';
      }
      if(range){
        range.value = filters.discount || 0;
      }
      postalBranchSlugs = null;
      updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
      fetchData();
    }

    updateCountryButtons();
    updateCountryMeta();
    setFiltersDisabled(false);
    populateStoreSelect(activeCountry);

    for(const button of countryButtons){
      button.addEventListener('click', () => {
        setCountry(button.dataset.country);
      });
    }
    const POSTAL_RADIUS_KM = 50;

    const BRANCH_COORDINATES = {
      'montreal': {lat:45.5019, lng:-73.5674},
      'laval': {lat:45.6066, lng:-73.7124},
      'saint-jerome': {lat:45.7811, lng:-74.0036}
    };

    let postalBranchSlugs = null;

    function toRadians(value){
      return value * Math.PI / 180;
    }

    function haversineDistanceKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNearbyBranches(referenceSlug, radiusKm){
      if(!referenceSlug) return [];
      const origin = BRANCH_COORDINATES[referenceSlug];
      if(!origin) return [];
      const branches = baseBranches();
      const nearby = [];
      for(const branch of branches){
        const coords = BRANCH_COORDINATES[branch.slug];
        if(!coords) continue;
        const distance = haversineDistanceKm(origin.lat, origin.lng, coords.lat, coords.lng);
        if(distance <= radiusKm){
          nearby.push({...branch, distance});
        }
      }
      return nearby.sort((a,b) => a.distance - b.distance);
    }

    function normalizePostal(value){
      if(!value) return '';
      return String(value).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Z0-9]/g,'');
    }

    function findPostalMatch(normalized){
      if(!normalized) return null;
      return POSTAL_DIRECTORY.find(entry => entry.prefixes.some(prefix => normalized.startsWith(prefix)));
    }

    function updatePostalHelper(message, isError){
      if(!postalHelper) return;
      postalHelper.textContent = message;
      postalHelper.classList.toggle('error', Boolean(isError));
    }

    function resetPostalFilter(){
      if(!postalInput) return;
      postalInput.value = '';
      postalInput.removeAttribute('aria-invalid');
      updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
      const hadFilter = postalBranchSlugs && postalBranchSlugs.size > 0;
      postalBranchSlugs = null;
      if(hadFilter){
        setCityOptions(storeSelect?.value ?? '', true);
      }
    }

    async function applyPostalSearch(raw){
      if(!postalInput) return;
      if(activeCountry !== 'canada') return;
      const hadFilter = postalBranchSlugs && postalBranchSlugs.size > 0;
      const normalized = normalizePostal(raw);
      if(!normalized){
        postalInput.removeAttribute('aria-invalid');
        updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
        if(hadFilter){
          postalBranchSlugs = null;
          setCityOptions(storeSelect?.value ?? '', true);
          if(citySelect){
            citySelect.value = '';
          }
          await fetchData();
        }
        return;
      }
      if(normalized.length < 3){
        postalInput.setAttribute('aria-invalid','true');
        updatePostalHelper('Indiquez au moins les 3 premiers caractères du code postal.', true);
        if(hadFilter){
          postalBranchSlugs = null;
          setCityOptions(storeSelect?.value ?? '', true);
          if(citySelect){
            citySelect.value = '';
          }
          await fetchData();
        }
        return;
      }
      const match = findPostalMatch(normalized);
      if(!match){
        postalInput.setAttribute('aria-invalid','true');
        updatePostalHelper('Code postal non reconnu dans les succursales couvertes.', true);
        if(hadFilter){
          postalBranchSlugs = null;
          setCityOptions(storeSelect?.value ?? '', true);
          if(citySelect){
            citySelect.value = '';
          }
          await fetchData();
        }
        return;
      }
      postalInput.removeAttribute('aria-invalid');
      const nearbyBranches = findNearbyBranches(match.branchSlug, POSTAL_RADIUS_KM);
      const nextSlugs = new Set(nearbyBranches.map(branch => branch.slug));
      if(nextSlugs.size === 0){
        nextSlugs.add(match.branchSlug);
      }
      let changed = nextSlugs.size !== (postalBranchSlugs?.size ?? 0);
      if(!changed && postalBranchSlugs){
        for(const slug of nextSlugs){
          if(!postalBranchSlugs.has(slug)){
            changed = true;
            break;
          }
        }
      }
      postalBranchSlugs = nextSlugs;
      if(changed){
        setCityOptions(storeSelect?.value ?? '', true);
        if(citySelect && citySelect.value && !postalBranchSlugs.has(citySelect.value)){
          citySelect.value = '';
        }
      }
      const helperBranches = nearbyBranches.length ? nearbyBranches : [{label: match.cityLabel}];
      const helperList = helperBranches.map(branch => branch.label).join(', ');
      updatePostalHelper(`Succursales dans un rayon de ${POSTAL_RADIUS_KM} km : ${helperList}.`, false);
      await fetchData();
    }

    if(postalInput){
      resetPostalFilter();
      let postalDebounce;
      postalInput.addEventListener('input', () => {
        clearTimeout(postalDebounce);
        const value = postalInput.value;
        postalDebounce = setTimeout(() => { applyPostalSearch(value); }, 300);
      });
      postalInput.addEventListener('blur', () => { applyPostalSearch(postalInput.value); });
      postalInput.addEventListener('keydown', (event) => {
        if(event.key === 'Enter'){
          event.preventDefault();
          applyPostalSearch(postalInput.value);
        }
      });
    }

    // Affiche l'année
    const y = new Date().getFullYear();
    document.getElementById('year').textContent = y;
    document.getElementById('yearFooter').textContent = y;

    function toNumber(value){
      if(typeof value === 'number' && Number.isFinite(value)) return value;
      if(typeof value === 'string'){
        const sanitized = value
          .replace(/[^0-9,.-]/g,'')
          .replace(/,(?=[^,]*,)/g,'')
          .replace(',','.');
        const num = Number(sanitized);
        return Number.isFinite(num) ? num : null;
      }
      return null;
    }

    function firstDefined(...values){
      for(const value of values){
        if(value !== undefined && value !== null && value !== '') return value;
      }
      return null;
    }

    function slugify(value){
      if(value === undefined || value === null) return '';
      const text = String(value).normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      return text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/--+/g,'-');
    }

    function normalizeDeal(item, storeLabel, branch){
      const branchLabel = typeof branch === 'object' && branch ? branch.label : branch;
      const branchSlug = typeof branch === 'object' && branch && branch.slug ? branch.slug : slugify(branchLabel || item.city || storeLabel);
      const cityLabel = typeof branch === 'object' && branch && branch.city ? branch.city : firstDefined(item.city, branchLabel, storeLabel);
      const citySlug = slugify(cityLabel);
      const regular = toNumber(firstDefined(
        item.original_price,
        item.originalPrice,
        item.regular_price,
        item.regularPrice,
        item.price_before,
        item.priceBefore,
        item.listPrice,
        item.price // fallback when only one price exists
      ));

      const sale = toNumber(firstDefined(
        item.salePrice,
        item.sale_price,
        item.discount_price,
        item.discountPrice,
        item.current_price,
        item.currentPrice,
        // When only price and original exist, price is the reduced amount
        item.price
      ));

      const finalRegular = regular ?? sale ?? 0;
      const finalSale = sale ?? regular ?? 0;

      const brand = firstDefined(
        item.brand,
        item.manufacturer,
        item.maker,
        item.vendor,
        item.brandName,
        item.brand_name
      );

      const model = firstDefined(
        item.model,
        item.modelNumber,
        item.model_number,
        item.modelNo,
        item.model_no,
        item.partNumber,
        item.part_number,
        item.mpn
      );

      const sku = firstDefined(
        item.sku,
        item.productCode,
        item.product_code,
        item.productId,
        item.product_id,
        item.itemNumber,
        item.item_number,
        item.id
      );

      const asin = firstDefined(item.asin, item.ASIN);

      const searchKeywords = firstDefined(
        item.searchKeywords,
        item.search_keywords,
        item.keywords,
        item.keyword
      );

      const amazonUrl = firstDefined(
        item.amazonUrl,
        item.amazon_url,
        item.amazonLink,
        item.amazon_link
      );

      return {
        title: firstDefined(item.title, item.name, 'Article en liquidation'),
        image: firstDefined(item.image, item.image_url, item.imageUrl, item.img, 'https://via.placeholder.com/400x300?text=Liquidation'),
        price: finalRegular,
        salePrice: finalSale,
        store: item.store ?? storeLabel,
        city: item.city ?? cityLabel,
        branch: branchLabel ?? cityLabel,
        branchSlug,
        citySlug,
        url: firstDefined(item.url, item.link, '#'),
        brand,
        model,
        sku,
        asin,
        searchKeywords,
        amazonUrl
      };
    }

    function discount(p,s){
      const price = Number(p);
      const sale = Number(s);
      if(!Number.isFinite(price) || price <= 0) return 0;
      if(!Number.isFinite(sale)) return 0;
      const clampedSale = Math.max(0, sale);
      const pct = Math.round((1 - (clampedSale / price)) * 100);
      return Number.isFinite(pct) ? Math.max(pct, 0) : 0;
    }
    function currency(value){
      const numeric = Number(value);
      if(!Number.isFinite(numeric)) return '—';
      const settings = getCurrencySettings(activeCountry);
      const rate = Number(settings.cadToLocalRate);
      const normalizedRate = Number.isFinite(rate) && rate > 0 ? rate : 1;
      const converted = numeric * normalizedRate;
      const locale = settings.locale || BASE_CURRENCY.locale;
      const code = settings.code || BASE_CURRENCY.code;
      try{
        return converted.toLocaleString(locale,{style:'currency',currency:code});
      }catch(_err){
        return converted.toLocaleString(BASE_CURRENCY.locale,{style:'currency',currency:BASE_CURRENCY.code});
      }
    }

    const deals = [];

    function renderStoreMenu(config){
      if(!config) return '';
      const items = Array.isArray(config.storeMenu) ? config.storeMenu.filter(item => item && item.label) : [];
      if(items.length === 0) return '';
      const title = config.storeMenuTitle || 'Magasins couverts';
      const description = config.storeMenuDescription || '';
      const list = items.map(item => {
        const label = item.label;
        const note = item.description ? `<span class="store-menu-note">${item.description}</span>` : '';
        return `<li><span class="store-menu-item" role="text"><span class="store-menu-label">${label}</span>${note}</span></li>`;
      }).join('');
      return `
        <nav class="store-menu" aria-label="${title}">
          <div>
            <h3>${title}</h3>
            ${description ? `<p>${description}</p>` : ''}
          </div>
          <ul class="store-menu-list">${list}</ul>
        </nav>
      `;
    }

    function renderCountryPreview(config){
      const blocks = [];
      if(config?.emptyNotice){
        blocks.push(`<div class="notice-card">${config.emptyNotice}</div>`);
      }
      const menu = renderStoreMenu(config);
      if(menu){
        blocks.push(menu);
      }
      return blocks.length ? `<div class="country-preview">${blocks.join('')}</div>` : '';
    }

    function sanitizeAmazonQuery(value){
      if(typeof value !== 'string' || !value.trim()){
        return 'liquidation';
      }
      const normalized = value
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9\s-]/g, ' ');
      const collapsed = normalized.trim().replace(/\s+/g, ' ');
      if(!collapsed){
        return 'liquidation';
      }
      const words = collapsed.split(' ').slice(0, 8);
      return words.join(' ');
    }

    function getAmazonDomain(country){
      const config = getCountryConfig(country);
      const domain = typeof config?.amazonDomain === 'string' ? config.amazonDomain.trim() : '';
      return domain || 'www.amazon.ca';
    }

    function normalizeAsin(value){
      if(value === undefined || value === null) return '';
      const text = String(value).trim();
      return /^[A-Z0-9]{8,}$/i.test(text) ? text : '';
    }

    function buildAmazonLink(deal){
      const domain = getAmazonDomain(activeCountry);
      if(!deal){
        const fallbackQuery = sanitizeAmazonQuery('liquidation');
        return `https://${domain}/s?k=${encodeURIComponent(fallbackQuery)}&ref=nb_sb_noss`;
      }

      const asin = normalizeAsin(deal.asin);
      if(asin){
        return `https://${domain}/dp/${encodeURIComponent(asin)}`;
      }

      const segments = [];
      const pushSegment = (value) => {
        if(value === undefined || value === null) return;
        const text = String(value).trim();
        if(text){
          segments.push(text);
        }
      };

      pushSegment(deal.searchKeywords);
      pushSegment(deal.brand);
      pushSegment(deal.model);
      pushSegment(deal.sku);
      pushSegment(deal.title);

      const querySource = segments.join(' ').trim();
      const query = sanitizeAmazonQuery(querySource || deal.title || 'liquidation');
      return `https://${domain}/s?k=${encodeURIComponent(query)}&ref=nb_sb_noss`;
    }

    function render(){
      rangeLabel.textContent = range.value + '%';
      if(activeCountry !== 'canada'){
        const config = getCountryConfig(activeCountry);
        countEl.textContent = '0';
        cardsEl.innerHTML = renderCountryPreview(config);
        return;
      }
      const s = storeSelect.value;
      const c = citySelect.value;
      const min = parseInt(range.value,10);
      const filtered = deals.filter(d => {
        const pct = discount(d.price,d.salePrice);
        if(s && d.store !== s) return false;
        if(c && d.branchSlug !== c && d.citySlug !== c) return false;
        return pct >= min;
      });
      countEl.textContent = filtered.length;
      if(filtered.length === 0){
        const config = getCountryConfig(activeCountry);
        cardsEl.innerHTML = renderCountryPreview(config) || '';
        return;
      }
      cardsEl.innerHTML = filtered.map(d=>{
        const amazonLink = d.amazonUrl || buildAmazonLink(d);
        const ebayLink = d.ebayUrl || `https://www.ebay.ca/sch/i.html?_nkw=${encodeURIComponent(d.title)}`;
        return `
        <article class="card">
          <img src="${d.image}" alt="${d.title}" loading="lazy"/>
          <div class="body">
            <div class="badge">-${discount(d.price,d.salePrice)}% Rabais</div>
            <h3>${d.title}</h3>
            <div class="muted">${d.store} · ${d.branch ?? d.city}</div>
            <div class="price"><div class="old">${currency(d.price)}</div><div>${currency(d.salePrice)}</div></div>
            <div class="action-stack">
              <a class="btn btn-primary" href="${d.url||'#'}" target="_blank" rel="noopener noreferrer">Voir</a>
              <div class="comparison-links">
                <a class="btn btn-secondary" href="${amazonLink}" target="_blank" rel="noopener noreferrer">Amazon</a>
                <a class="btn btn-secondary" href="${ebayLink}" target="_blank" rel="noopener noreferrer">eBay</a>
              </div>
            </div>
          </div>
        </article>`;
      }).join('');
    }

    function getStoreBySlug(slug){
      return STORES.find(store => store.slug === slug);
    }

    function getStoreByIdentifier(identifier){
      if(!identifier) return null;
      return getStoreBySlug(identifier) || STORES.find(store => store.label === identifier);
    }

    const BEST_BUY_AGGREGATE_PATH = 'data/best-buy/liquidations.json';

    function filePathFor(store, branch){
      const s = store?.slug;
      const c = branch?.slug;
      if(!s) return null;
      if(s === 'best-buy'){
        if(c === 'en-ligne') return BEST_BUY_AGGREGATE_PATH;
        if(!c) return BEST_BUY_AGGREGATE_PATH;
      }
      if(!c) return null;
      return `data/${s}/${c}.json`;
    }

    async function canadianTireHasData(slug){
      if(DEFAULT_BRANCH_SLUGS.has(slug)) return true;
      const path = `data/canadian-tire/${slug}.json`;
      try{
        const head = await fetch(path, {method:'HEAD'});
        if(head.ok) return true;
      }catch(_err){ /* noop */ }
      try{
        const res = await fetch(path, {cache:'no-store'});
        return res.ok;
      }catch(_err){
        return false;
      }
    }

    async function loadCanadianTireDirectory(){
      const store = STORES.find(entry => entry.slug === 'canadian-tire');
      if(!store) return;
      try{
        const res = await fetch('data/canadian-tire/stores.json', {cache:'no-store'});
        if(!res.ok) return;
        const json = await res.json();
        if(!Array.isArray(json)) return;
        const availabilityCache = new Map();
        async function branchHasData(slug){
          if(availabilityCache.has(slug)) return availabilityCache.get(slug);
          const hasData = await canadianTireHasData(slug);
          availabilityCache.set(slug, hasData);
          return hasData;
        }
        const seen = new Map();
        for(const branch of store.branches){
          const slug = branch?.slug;
          if(!slug) continue;
          const hasData = await branchHasData(slug);
          seen.set(slug, {...branch, hasData});
        }
        for(const entry of json){
          const rawSlug = typeof entry.slug === 'string' && entry.slug ? entry.slug : slugify(entry.nickname || entry.city || entry.label);
          if(!rawSlug) continue;
          const label = (entry.nickname || (entry.label || '').replace(/^Canadian Tire\s*/i, '') || entry.city || rawSlug).trim();
          const city = entry.city || label;
          const hasData = await branchHasData(rawSlug);
          const previous = seen.get(rawSlug) || {};
          seen.set(rawSlug, {...previous, label, slug: rawSlug, city, hasData});
        }
        store.branches = Array.from(seen.values()).sort((a,b)=>a.label.localeCompare(b.label,'fr'));
      }catch(err){
        console.warn('Impossible de charger les succursales Canadian Tire', err);
      }
    }

    function setCityOptions(storeSlug, preserveSelection){
      const previous = preserveSelection ? citySelect.value : '';
      const store = getStoreByIdentifier(storeSlug);
      const branches = store?.branches ?? baseBranches();
      const options = ['<option value="">(Toutes)</option>'];
      const postalFilter = postalBranchSlugs && postalBranchSlugs.size ? postalBranchSlugs : null;
      for(const branch of branches){
        const baseLabel = branch.hasData === false ? `${branch.label} (bientôt)` : branch.label;
        const isNearby = postalFilter ? postalFilter.has(branch.slug) : false;
        const displayLabel = isNearby ? `${baseLabel} – à proximité` : baseLabel;
        const attrs = [];
        if(branch.hasData === false) attrs.push('data-empty="true"');
        if(isNearby) attrs.push('data-nearby="true"');
        const attrString = attrs.length ? ` ${attrs.join(' ')}` : '';
        options.push(`<option value="${branch.slug}"${attrString}>${displayLabel}</option>`);
      }
      citySelect.innerHTML = options.join('');
      if(preserveSelection && branches.some(branch => branch.slug === previous)){
        citySelect.value = previous;
      }else{
        citySelect.value = '';
      }
    }

    async function fetchOne(path, storeLabel, branch){
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) return [];
        const json = await res.json();
        if(!Array.isArray(json)) return [];
        return json.map(item => normalizeDeal(item, storeLabel, branch));
      }catch(e){ console.warn('fetch fail', path, e); return []; }
    }

    async function fetchData(){
      if(activeCountry !== 'canada'){
        render();
        return;
      }
      deals.length = 0;
      const storeFilter = storeSelect.value;
      const branchFilter = citySelect.value;
      const postalFilter = postalBranchSlugs && postalBranchSlugs.size ? postalBranchSlugs : null;
      const selectedStores = storeFilter ? [storeFilter] : STORES.map(store => store.slug);
      const tasks = [];
      for(const storeSlug of selectedStores){
        const store = getStoreByIdentifier(storeSlug);
        if(!store) continue;
        let branches = store.branches ?? [];
        if(branchFilter){
          branches = branches.filter(branch => branch.slug === branchFilter);
          if(branches.length === 0) continue;
        }else if(postalFilter){
          const filtered = branches.filter(branch => postalFilter.has(branch.slug));
          if(filtered.length === 0) continue;
          branches = filtered;
        }else if(!storeFilter){
          const defaults = branches.filter(branch => DEFAULT_BRANCH_SLUGS.has(branch.slug));
          branches = defaults.length ? defaults : branches;
        }
        if(branches.length === 0){
          if(postalFilter){
            continue;
          }
          branches = (store.branches ?? []).filter(branch => DEFAULT_BRANCH_SLUGS.has(branch.slug));
        }
        for(const branch of branches){
          if(branch.hasData === false) continue;
          const path = filePathFor(store, branch);
          if(path) tasks.push({store, branch, path});
        }
      }
      const seen = new Set();
      for(const task of tasks){
        if(seen.has(task.path)) continue;
        seen.add(task.path);
        const arr = await fetchOne(task.path, task.store.label, task.branch);
        for(const d of arr){ deals.push(d); }
      }
      render();
    }

    storeSelect.addEventListener('change', () => {
      if(activeCountry !== 'canada') return;
      setCityOptions(storeSelect.value, false);
      fetchData();
    });
    citySelect.addEventListener('change', () => {
      if(activeCountry !== 'canada') return;
      if(postalInput && !normalizePostal(postalInput.value)){
        updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
      }
      fetchData();
    });
    range.addEventListener('input', render);
    btnClear.addEventListener('click', async ()=>{
      if(activeCountry !== 'canada') return;
      const defaults = DEFAULT_FILTERS;
      const defaultStore = getStoreByIdentifier(defaults.store);
      const defaultStoreValue = defaultStore?.slug || '';
      storeSelect.value = defaultStoreValue;
      setCityOptions(defaultStoreValue, false);
      if(citySelect){
        if(defaults.city){
          const options = Array.from(citySelect.options || []);
          citySelect.value = options.some(option => option.value === defaults.city) ? defaults.city : '';
        }else{
          citySelect.value='';
        }
      }
      range.value = defaults.discount ?? '0';
      resetPostalFilter();
      await fetchData();
    });

    // Démarrage
    await loadCanadianTireDirectory();
    const defaultStore = getStoreByIdentifier(DEFAULT_FILTERS.store);
    const defaultStoreValue = defaultStore?.slug || '';
    storeSelect.value = defaultStoreValue;
    setCityOptions(defaultStoreValue, false);
    citySelect.value = DEFAULT_FILTERS.city;
    range.value = DEFAULT_FILTERS.discount; // ← 0% par défaut
    await fetchData();
  });
  </script>
</body>
</html>
