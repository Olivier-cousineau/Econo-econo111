<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORES = [
    {label:'Home Depot', slug:'home-depot'},
    {label:'Walmart', slug:'walmart'},
    {label:'Canadian Tire', slug:'canadian-tire'},
    {label:'Rona', slug:'rona'},
    {label:'Patrick Morin', slug:'patrick-morin'},
    {label:'Sporting Life', slug:'sporting-life'}
  ];
  const CITIES = [
    {label:'Montréal', slug:'montreal'},
    {label:'Laval', slug:'laval'},
    {label:'Saint-Jérôme', slug:'saint-jerome'}
  ];

  const storeSelect = document.getElementById('storeSelect');
  const citySelect  = document.getElementById('citySelect');
  const range       = document.getElementById('discountRange');
  const rangeLabel  = document.getElementById('discountValue');
  const cardsEl     = document.getElementById('cards');
  const countEl     = document.getElementById('resultCount');
  const btnClear    = document.getElementById('btnClear');
  const devError    = document.getElementById('devError');

  // Show year
  const y = new Date().getFullYear();
  document.getElementById('year').textContent = y;
  document.getElementById('yearFooter').textContent = y;

  // Normalization helper: lowercase, remove accents, trim
  function norm(s){
    if(!s) return '';
    s = String(s).toLowerCase().trim();
    s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // remove accents
    s = s.replace(/[^a-z0-9\s\-]/g, ''); // keep letters/numbers/spaces/dash
    return s.replace(/\s+/g, ' ').trim();
  }

  // safe discount calc: returns integer >=0 or 0 if invalid
  function discount(original, sale){
    const p = Number(original);
    const s = Number(sale);
    if(!isFinite(p) || !isFinite(s) || p <= 0) return 0;
    return Math.max(0, Math.round((1 - (s / p)) * 100));
  }

  // safe currency display: show "-" when missing
  function currency(n){
    if(!isFinite(Number(n))) return "-";
    return Number(n).toLocaleString('fr-CA', {style:'currency', currency:'CAD'});
  }

  // show dev error banner
  function showError(msg){
    devError.style.display = 'block';
    devError.textContent = msg;
  }
  function hideError(){ devError.style.display = 'none'; devError.textContent = ''; }

  const deals = [];

  function render(){
    hideError();
    rangeLabel.textContent = range.value + '%';
    const selectedStore = norm(storeSelect.value);
    const selectedCity  = norm(citySelect.value);
    const min = parseInt(range.value, 10) || 0;

    const filtered = deals.filter(d => {
      // ensure numbers are usable
      const p = Number(d.price);
      const s = Number(d.salePrice);
      if(!isFinite(p) || !isFinite(s)) return false;
      const pct = discount(p, s);

      // tolerant match: store and city may include extra text (e.g. "Home Depot - Laval")
      const storeOK = !selectedStore || norm(d.store || '').includes(selectedStore);
      const cityOK  = !selectedCity  || norm(d.city  || '').includes(selectedCity);
      return storeOK && cityOK && pct >= min;
    });

    countEl.textContent = filtered.length;
    if(filtered.length === 0){
      cardsEl.innerHTML = '<p class="muted">Aucun article correspondant aux filtres.</p>';
      return;
    }

    cardsEl.innerHTML = filtered.map(d => {
      const pct = discount(d.price, d.salePrice);
      return `
      <article class="card">
        <img src="${d.image || ''}" alt="${(d.title || '').replace(/"/g,'')}" loading="lazy"/>
        <div class="body">
          <div class="badge">-${pct}% Rabais</div>
          <h3>${d.title || ''}</h3>
          <div class="muted">${d.store || ''} · ${d.city || ''}</div>
          <div class="price"><div class="old">${currency(d.price)}</div><div>${currency(d.salePrice)}</div></div>
          <a class="btn" href="${d.url || '#'}" target="_blank" rel="noopener" style="width:100%">Voir</a>
        </div>
      </article>`;
    }).join('');
  }

  function filePathFor(storeLabel, cityLabel){
    const s = (STORES.find(x => x.label === storeLabel) || {}).slug;
    const c = (CITIES.find(x => x.label === cityLabel) || {}).slug;
    if(!s || !c) return null;
    return `data/${s}/${c}.json`;
  }

  async function fetchOne(path){
    try{
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok){
        // show a visible error for debugging
        showError(`Échec du chargement : ${path} (status ${res.status})`);
        console.warn('fetch non ok', path, res.status);
        return [];
      }
      const j = await res.json();
      if(!Array.isArray(j)) {
        showError(`Format invalide JSON: ${path} (attendu tableau)`);
        return [];
      }
      return j;
    } catch(e){
      console.warn('fetch fail', path, e);
      showError(`Impossible de charger ${path} — voir console.`);
      return [];
    }
  }

  async function fetchData(){
    hideError();
    deals.length = 0;
    const stores = storeSelect.value ? [storeSelect.value] : STORES.map(s => s.label);
    const cities = citySelect.value  ? [citySelect.value]  : CITIES.map(c => c.label);

    for(const s of stores){
      for(const c of cities){
        const path = filePathFor(s, c);
        if(!path) continue;
        const arr = await fetchOne(path);
        for(const d of arr){
          // normalize keys that frontend expects
          const item = {
            title: d.title || d.name || d.name_fr || '',
            price: (d.price != null ? Number(d.price) : (d.original_price != null ? Number(d.original_price) : null)),
            salePrice: (d.salePrice != null ? Number(d.salePrice) : (d.price != null ? Number(d.price) : null)),
            image: d.image || d.img || d.image_url || '',
            url: d.url || d.link || '',
            store: d.store || s,
            city: d.city || c
          };
          deals.push(item);
        }
      }
    }
    render();
  }

  // Events
  storeSelect.addEventListener('change', fetchData);
  citySelect.addEventListener('change', fetchData);
  range.addEventListener('input', render);
  btnClear.addEventListener('click', () => { storeSelect.value = ''; citySelect.value = ''; range.value = 0; fetchData(); });

  // Initial values — choisis une valeur par défaut qui existe dans tes fichiers
  storeSelect.value = 'Rona';            // <-- change si besoin
  citySelect.value  = 'Saint-Jérôme';   // <-- change si besoin
  range.value = 0;
  fetchData();
});
</script>
