<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EconoDeal — Canada</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div id="registrationOverlay" class="hidden" role="dialog" aria-modal="true" aria-labelledby="registrationTitle" aria-hidden="true">
    <div class="registration-card">
      <button type="button" class="overlay-close" data-close-overlay aria-label="Fermer la fenêtre d'inscription">&times;</button>
      <h2 id="registrationTitle">Accès réservé aux membres</h2>
      <p class="muted" style="margin:0">Rejoignez <strong><span data-client-count>0</span></strong> chasseurs de rabais et accédez au catalogue complet.</p>
      <form id="registrationForm">
        <div>
          <label for="fullName">Nom complet</label>
          <input id="fullName" name="fullName" type="text" placeholder="Entrez votre nom" autocomplete="name" required />
        </div>
        <div>
          <label for="email">Courriel</label>
          <input id="email" name="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
        </div>
        <div class="checkbox-row">
          <input id="regulationCheckbox" name="regulation" type="checkbox" required />
          <label for="regulationCheckbox" style="margin:0">Je confirme avoir lu et accepté les réglementations d'utilisation du site.</label>
        </div>
        <div class="overlay-actions">
          <button id="registrationSubmit" type="submit" disabled>S'inscrire et accéder</button>
          <button type="button" class="ghost-button" data-close-overlay>Plus tard</button>
        </div>
      </form>
    </div>
  </div>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:10px;align-items:center">
        <h1>EconoDeal</h1>
      </div>
      <div class="row" style="gap:12px;align-items:center">
        <a class="nav-button" href="pricing.html" style="white-space:nowrap">Forfaits / prix</a>
        <a class="nav-button" href="roadmap.html" style="white-space:nowrap">Roadmap / vision</a>
        <div class="muted" style="white-space:nowrap">Clients inscrits&nbsp;: <span data-client-count>0</span></div>
        <div class="muted">© <span id="year"></span></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <span class="chip">Plateforme 2025</span>
        <h2>La nouvelle façon de traquer les liquidations</h2>
        <p>Anticipez les meilleures aubaines canadiennes grâce à un suivi intelligent, des alertes instantanées et une analyse propulsée par l'IA.</p>
        <div class="hero-actions">
          <button type="button" class="btn-primary" data-open-overlay>Créer mon accès</button>
          <a class="ghost-button" href="pricing.html">Explorer les forfaits</a>
        </div>
        <div class="hero-meta">
          <div class="meta-card">
            <strong><span data-client-count>0</span> membres</strong>
            <span class="muted">font confiance à EconoDeal</span>
          </div>
          <div class="meta-card">
            <strong>IA prédictive</strong>
            <span class="muted">Prévisions 48&nbsp;h à l'avance</span>
          </div>
          <div class="meta-card">
            <strong>Couverture nationale</strong>
            <span class="muted">120+ détaillants monitorés</span>
          </div>
        </div>
      </div>
      <div class="hero-visual">
        <div class="hero-glow"></div>
        <div class="hero-card">
          <span class="chip" style="width:max-content">Flux en direct</span>
          <h3>Liquidations à fort impact</h3>
          <div class="status">
            <span class="muted">Mise à jour</span>
            <strong>Il y a 3 min</strong>
          </div>
          <div class="sparkline">
            <div class="sparkline-bar"><span style="width:92%"></span></div>
            <div class="sparkline-bar"><span style="width:78%"></span></div>
            <div class="sparkline-bar"><span style="width:64%"></span></div>
          </div>
          <div class="meta-card" style="margin:0">
            <strong>+34&nbsp;% d'économie moyenne</strong>
            <span class="muted">chez nos membres actifs</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="search">
      <div>
        <h2 style="margin:0">Trouver des liquidations</h2>
        <p class="muted">Les fichiers sont chargés depuis <span class="kbd">data/&lt;magasin&gt;/&lt;ville&gt;.json</span>.</p>
      </div>

      <!-- ✅ Les éléments requis existent et leurs IDs correspondent au script -->
      <div class="glass-panel filters-wrapper">
        <div class="filters">
          <div>
            <label for="storeSelect">Magasin</label>
            <select id="storeSelect">
              <option value="">(Tous)</option>
              <option>Home Depot</option>
              <option>Walmart</option>
              <option>Canadian Tire</option>
              <option>Rona</option>
              <option>Patrick Morin</option>
              <option>Sporting Life</option>
            </select>
          </div>
          <div>
            <label for="citySelect">Ville</label>
            <select id="citySelect">
              <option value="">(Toutes)</option>
            </select>
          </div>
          <div>
            <label for="postalInput">Code postal</label>
            <input id="postalInput" name="postal" type="text" inputmode="text" placeholder="Ex. H2X 1Y4" autocomplete="postal-code" />
            <p id="postalHelper" class="field-helper">Entrez les 3 premiers caractères du code postal (ex. H2X).</p>
          </div>
          <div>
            <label for="discountRange">% de rabais minimal : <span id="discountValue" class="kbd">0%</span></label>
            <input id="discountRange" type="range" min="0" max="90" step="5" value="0" />
          </div>
          <div style="align-self:end">
            <button id="btnClear">Réinitialiser</button>
          </div>
        </div>
      </div>

      <div id="devError" class="dev-banner"></div>

      <div class="glass-panel">
        <div class="results-header">
          <h3 style="margin:0">Résultats</h3>
          <div class="muted"><span id="resultCount">0</span> articles</div>
        </div>
        <div id="cards" class="grid"></div>
      </div>
    </section>

    <section class="section" id="pricing" style="padding-top:10px">
      <div class="glass-panel">
        <div class="section-intro">
          <h2 style="margin:0">Forfaits adaptés à vos besoins</h2>
          <p class="muted">Choisissez l'option qui correspond le mieux à votre façon de surveiller les rabais et liquidations au Canada. Chaque forfait inclut une période d'essai de 7 jours.</p>
        </div>
        <div class="pricing-grid">
          <article class="pricing-card">
            <div class="pricing-tag">Essentiel</div>
            <h4>Accès de base</h4>
            <div class="pricing-price">9,99&nbsp;$</div>
            <ul class="pricing-features">
              <li>Accès aux liquidations populaires</li>
              <li>3 alertes courriel par semaine</li>
              <li>Historique de prix sur 30 jours</li>
            </ul>
          </article>
          <article class="pricing-card pricing-highlight">
            <div class="pricing-tag">Le plus populaire</div>
            <h4>Forfait Avancé</h4>
            <div class="pricing-price">19,99&nbsp;$</div>
            <ul class="pricing-features">
              <li>Accès illimité au catalogue</li>
              <li>Alertes personnalisées en temps réel</li>
              <li>Listes partagées avec votre équipe</li>
            </ul>
          </article>
          <article class="pricing-card">
            <div class="pricing-tag">Premium</div>
            <h4>Analyse IA complète</h4>
            <div class="pricing-price">29,99&nbsp;$</div>
            <ul class="pricing-features">
              <li>Alertes illimitées multicanal</li>
              <li>Analyse des prix assistée par IA</li>
              <li>Prévisions de tendances du marché</li>
            </ul>
          </article>
        </div>
      </div>
    </section>

    <section class="section" id="roadmap" style="padding-top:0">
      <div class="section-intro">
        <h2 style="margin:0">Notre feuille de route</h2>
        <p class="muted">Une vision triennale pour propulser EconoDeal sur la scène internationale, avec une intégration progressive de l'intelligence artificielle au cœur de nos services.</p>
      </div>
      <div class="roadmap">
        <div class="roadmap-grid">
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 1</strong> Canada</div>
            <ul>
              <li>Consolider la couverture des détaillants nationaux.</li>
              <li>Optimiser les alertes de rabais en temps réel.</li>
              <li>Lancer des tableaux de bord régionaux bilingues.</li>
            </ul>
          </article>
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 2</strong> États-Unis</div>
            <ul>
              <li>Élargir le catalogue aux grandes bannières américaines.</li>
              <li>Déployer la surveillance des stocks multi-états.</li>
              <li>Introduire l'analyse prédictive des tendances d'achat.</li>
            </ul>
          </article>
          <article class="roadmap-card roadmap-ai">
            <div class="roadmap-year"><strong>Année 3</strong> Europe</div>
            <ul>
              <li>Localiser l'expérience pour les principaux marchés européens.</li>
              <li>Activer un moteur de recommandations IA multilingue.</li>
              <li>Automatiser les stratégies de prix grâce à l'apprentissage continu.</li>
            </ul>
          </article>
        </div>
      </div>
    </section>
  </main>

  <div class="container footer">
    © <span id="yearFooter"></span> EconoDeal · Tous droits réservés
  </div>

  <script>
  // === Initialisation sûre ===
  document.addEventListener('DOMContentLoaded', async () => {
    const overlay = document.getElementById('registrationOverlay');
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('registrationSubmit');
    const regulationCheckbox = document.getElementById('regulationCheckbox');
    const clientCountDisplays = Array.from(document.querySelectorAll('[data-client-count]'));
    const overlayToggleButtons = Array.from(document.querySelectorAll('[data-open-overlay]'));
    const overlayCloseButtons = Array.from(document.querySelectorAll('[data-close-overlay]'));
    let lastFocusedElement = null;
    const OVERLAY_DISMISSED_KEY = 'econodealOverlayDismissed';

    function parseJson(value){
      if(!value) return null;
      try{
        return JSON.parse(value);
      }catch(err){
        console.warn('Impossible de lire les données existantes', err);
        return null;
      }
    }

    function safeGet(key){
      try{
        return localStorage.getItem(key);
      }catch(err){
        console.warn('Stockage local indisponible', err);
        return null;
      }
    }

    function safeSet(key, value){
      try{
        localStorage.setItem(key, value);
      }catch(err){
        console.warn('Impossible d\'enregistrer les données', err);
      }
    }

    function safeRemove(key){
      try{
        localStorage.removeItem(key);
      }catch(err){
        console.warn('Impossible de supprimer les données', err);
      }
    }

    function cleanText(value){
      return typeof value === 'string' ? value.trim() : '';
    }

    function getRegistrations(){
      const parsed = parseJson(safeGet('econodealRegistrations'));
      if(!Array.isArray(parsed)) return [];
      return parsed
        .filter(item => item && typeof item === 'object')
        .map(item => ({
          name: cleanText(item.name),
          email: cleanText(item.email).toLowerCase(),
          registeredAt: cleanText(item.registeredAt)
        }))
        .filter(item => item.email);
    }

    function saveRegistrations(items){
      safeSet('econodealRegistrations', JSON.stringify(items));
    }

    function upsertRegistration(entry){
      const collection = getRegistrations();
      const email = cleanText(entry.email).toLowerCase();
      if(!email) return;

      const normalized = {
        name: cleanText(entry.name),
        email,
        registeredAt: cleanText(entry.registeredAt)
      };

      const existingIndex = collection.findIndex(item => item.email === email);
      if(existingIndex >= 0){
        collection[existingIndex] = {
          ...collection[existingIndex],
          ...normalized
        };
      }else{
        collection.push(normalized);
      }

      saveRegistrations(collection);
    }

    function parseCount(value){
      const parsed = parseInt(value ?? '0', 10);
      return Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
    }

    function getClientCount(){
      return parseCount(safeGet('econodealClientCount'));
    }

    function setClientCount(value){
      safeSet('econodealClientCount', String(Math.max(0, value)));
    }

    function updateClientCountDisplays(){
      const formatter = new Intl.NumberFormat('fr-CA');
      const count = getClientCount();
      clientCountDisplays.forEach(el => {
        el.textContent = formatter.format(count);
      });
    }

    function hideOverlay(options = {}){
      if(!overlay) return;
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('overlay-active');
      if(lastFocusedElement && typeof lastFocusedElement.focus === 'function'){
        lastFocusedElement.focus();
      }
      lastFocusedElement = null;
      if(options.persistDismissal){
        safeSet(OVERLAY_DISMISSED_KEY, 'true');
      }
    }

    function showOverlay(){
      if(!overlay) return;
      lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      overlay.classList.remove('hidden');
      overlay.removeAttribute('aria-hidden');
      document.body.classList.add('overlay-active');
      safeRemove(OVERLAY_DISMISSED_KEY);
      updateClientCountDisplays();
      const firstField = overlay.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
      if(firstField instanceof HTMLElement){
        firstField.focus();
      }
    }

    overlayToggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        showOverlay();
      });
    });

    overlayCloseButtons.forEach(button => {
      button.addEventListener('click', () => {
        hideOverlay({persistDismissal:true});
      });
    });

    if(overlay){
      overlay.addEventListener('click', (event) => {
        if(event.target === overlay){
          hideOverlay({persistDismissal:true});
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if(event.key === 'Escape' && document.body.classList.contains('overlay-active')){
        hideOverlay({persistDismissal:true});
      }
    });

    updateClientCountDisplays();

    const alreadyRegistered = safeGet('econodealClientRegistered') === 'true';
    const overlayDismissed = safeGet(OVERLAY_DISMISSED_KEY) === 'true';
    if(alreadyRegistered){
      safeSet(OVERLAY_DISMISSED_KEY, 'true');
      hideOverlay();
    }else{
      const currentUrl = new URL(window.location.href);
      const wantsOverlay = currentUrl.hash === '#inscription' || currentUrl.searchParams.get('inscription') === '1';
      if(wantsOverlay && !overlayDismissed){
        showOverlay();
      }else{
        hideOverlay();
      }
    }

    if(submitBtn && regulationCheckbox){
      submitBtn.disabled = !regulationCheckbox.checked;
      regulationCheckbox.addEventListener('change', () => {
        submitBtn.disabled = !regulationCheckbox.checked;
      });
    }

    if(form){
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        if(!form.reportValidity()) return;

        const wasRegistered = safeGet('econodealClientRegistered') === 'true';
        if(!wasRegistered){
          const current = getClientCount();
          setClientCount(current + 1);
        }

        const payload = {
          name: (form.fullName?.value ?? '').trim(),
          email: (form.email?.value ?? '').trim(),
          consent: true,
          registeredAt: new Date().toISOString()
        };

        safeSet('econodealUser', JSON.stringify(payload));
        upsertRegistration(payload);
        safeSet('econodealClientRegistered', 'true');
        updateClientCountDisplays();
        hideOverlay({persistDismissal:true});
      });
    }

    function baseBranches(){
      return [
        {label:'Montréal', slug:'montreal', city:'Montréal'},
        {label:'Laval', slug:'laval', city:'Laval'},
        {label:'Saint-Jérôme', slug:'saint-jerome', city:'Saint-Jérôme'}
      ];
    }

    const DEFAULT_BRANCH_SLUGS = new Set(baseBranches().map(branch => branch.slug));

    const STORES = [
      {label:'Home Depot', slug:'home-depot', branches: baseBranches()},
      {label:'Walmart', slug:'walmart', branches: baseBranches()},
      {label:'Canadian Tire', slug:'canadian-tire', branches: baseBranches()},
      {label:'Rona', slug:'rona', branches: baseBranches()},
      {label:'Patrick Morin', slug:'patrick-morin', branches: baseBranches()},
      {label:'Sporting Life', slug:'sporting-life', branches: baseBranches()}
    ];

    const POSTAL_DIRECTORY = [
      {
        branchSlug:'montreal',
        cityLabel:'Montréal (Île)',
        prefixes:[
          'H1A','H1B','H1C','H1E','H1G','H1H','H1J','H1K','H1L','H1M','H1N','H1P','H1R','H1S','H1T','H1V','H1W','H1X','H1Y','H1Z',
          'H2A','H2B','H2C','H2E','H2G','H2H','H2J','H2K','H2L','H2M','H2N','H2P','H2R','H2S','H2T','H2V','H2W','H2X','H2Y','H2Z',
          'H3A','H3B','H3C','H3E','H3G','H3H','H3J','H3K','H3L','H3M','H3N','H3R','H3S','H3T','H3V','H3W','H3X','H3Y','H3Z',
          'H4A','H4B','H4C','H4E','H4G','H4H','H4J','H4K','H4L','H4M','H4N','H4P','H4R','H4S','H4T','H4V','H4W','H4X'
        ]
      },
      {
        branchSlug:'laval',
        cityLabel:'Laval',
        prefixes:[
          'H7A','H7B','H7C','H7E','H7G','H7H','H7J','H7K','H7L','H7M','H7N','H7P','H7R','H7S','H7T','H7V','H7W','H7X','H7Y','H7Z',
          'H8N','H8P','H8R','H8T','H8Y'
        ]
      },
      {
        branchSlug:'saint-jerome',
        cityLabel:'Saint-Jérôme',
        prefixes:['J5L','J7Y','J7Z','J8A']
      }
    ];

    const storeSelect = document.getElementById('storeSelect');
    const citySelect  = document.getElementById('citySelect');
    const range       = document.getElementById('discountRange');
    const rangeLabel  = document.getElementById('discountValue');
    const cardsEl     = document.getElementById('cards');
    const countEl     = document.getElementById('resultCount');
    const btnClear    = document.getElementById('btnClear');
    const devError    = document.getElementById('devError');
    const postalInput = document.getElementById('postalInput');
    const postalHelper = document.getElementById('postalHelper');

    const DEFAULT_POSTAL_MESSAGE = 'Entrez les 3 premiers caractères du code postal (ex. H2X).';

    function normalizePostal(value){
      if(!value) return '';
      return String(value).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Z0-9]/g,'');
    }

    function findPostalMatch(normalized){
      if(!normalized) return null;
      return POSTAL_DIRECTORY.find(entry => entry.prefixes.some(prefix => normalized.startsWith(prefix)));
    }

    function updatePostalHelper(message, isError){
      if(!postalHelper) return;
      postalHelper.textContent = message;
      postalHelper.classList.toggle('error', Boolean(isError));
    }

    function resetPostalFilter(){
      if(!postalInput) return;
      postalInput.value = '';
      postalInput.removeAttribute('aria-invalid');
      updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
    }

    function ensureBranchOption(slug){
      if(!slug) return;
      const hasOption = Array.from(citySelect?.options ?? []).some(option => option.value === slug);
      if(hasOption) return;
      setCityOptions(storeSelect?.value ?? '', true);
    }

    async function applyPostalSearch(raw){
      if(!postalInput) return;
      const normalized = normalizePostal(raw);
      if(!normalized){
        postalInput.removeAttribute('aria-invalid');
        updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
        return;
      }
      if(normalized.length < 3){
        postalInput.setAttribute('aria-invalid','true');
        updatePostalHelper('Indiquez au moins les 3 premiers caractères du code postal.', true);
        return;
      }
      const match = findPostalMatch(normalized);
      if(!match){
        postalInput.setAttribute('aria-invalid','true');
        updatePostalHelper('Code postal non reconnu dans les succursales couvertes.', true);
        return;
      }
      postalInput.removeAttribute('aria-invalid');
      updatePostalHelper(`Succursale détectée : ${match.cityLabel}.`, false);
      ensureBranchOption(match.branchSlug);
      if(citySelect){
        citySelect.value = match.branchSlug;
      }
      await fetchData();
    }

    if(postalInput){
      resetPostalFilter();
      let postalDebounce;
      postalInput.addEventListener('input', () => {
        clearTimeout(postalDebounce);
        const value = postalInput.value;
        postalDebounce = setTimeout(() => { applyPostalSearch(value); }, 300);
      });
      postalInput.addEventListener('blur', () => { applyPostalSearch(postalInput.value); });
      postalInput.addEventListener('keydown', (event) => {
        if(event.key === 'Enter'){
          event.preventDefault();
          applyPostalSearch(postalInput.value);
        }
      });
    }

    // Affiche l'année
    const y = new Date().getFullYear();
    document.getElementById('year').textContent = y;
    document.getElementById('yearFooter').textContent = y;

    function toNumber(value){
      if(typeof value === 'number' && Number.isFinite(value)) return value;
      if(typeof value === 'string'){
        const sanitized = value
          .replace(/[^0-9,.-]/g,'')
          .replace(/,(?=[^,]*,)/g,'')
          .replace(',','.');
        const num = Number(sanitized);
        return Number.isFinite(num) ? num : null;
      }
      return null;
    }

    function firstDefined(...values){
      for(const value of values){
        if(value !== undefined && value !== null && value !== '') return value;
      }
      return null;
    }

    function slugify(value){
      if(value === undefined || value === null) return '';
      const text = String(value).normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      return text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/--+/g,'-');
    }

    function normalizeDeal(item, storeLabel, branch){
      const branchLabel = typeof branch === 'object' && branch ? branch.label : branch;
      const branchSlug = typeof branch === 'object' && branch && branch.slug ? branch.slug : slugify(branchLabel || item.city || storeLabel);
      const cityLabel = typeof branch === 'object' && branch && branch.city ? branch.city : firstDefined(item.city, branchLabel, storeLabel);
      const citySlug = slugify(cityLabel);
      const regular = toNumber(firstDefined(
        item.original_price,
        item.originalPrice,
        item.regular_price,
        item.regularPrice,
        item.price_before,
        item.priceBefore,
        item.listPrice,
        item.price // fallback when only one price exists
      ));

      const sale = toNumber(firstDefined(
        item.salePrice,
        item.sale_price,
        item.discount_price,
        item.discountPrice,
        item.current_price,
        item.currentPrice,
        // When only price and original exist, price is the reduced amount
        item.price
      ));

      const finalRegular = regular ?? sale ?? 0;
      const finalSale = sale ?? regular ?? 0;

      return {
        title: firstDefined(item.title, item.name, 'Article en liquidation'),
        image: firstDefined(item.image, item.image_url, item.imageUrl, item.img, 'https://via.placeholder.com/400x300?text=Liquidation'),
        price: finalRegular,
        salePrice: finalSale,
        store: item.store ?? storeLabel,
        city: item.city ?? cityLabel,
        branch: branchLabel ?? cityLabel,
        branchSlug,
        citySlug,
        url: firstDefined(item.url, item.link, '#')
      };
    }

    function discount(p,s){
      if(!p || !s || !Number.isFinite(p) || !Number.isFinite(s) || p === 0) return 0;
      const pct = Math.round((1 - (s / p)) * 100);
      return Number.isFinite(pct) ? Math.max(pct, 0) : 0;
    }
    function currency(n){ return n.toLocaleString('fr-CA',{style:'currency',currency:'CAD'}); }

    const deals = [];

    function render(){
      rangeLabel.textContent = range.value + '%';
      const s = storeSelect.value;
      const c = citySelect.value;
      const min = parseInt(range.value,10);
      const filtered = deals.filter(d => {
        const pct = discount(d.price,d.salePrice);
        if(s && d.store !== s) return false;
        if(c && d.branchSlug !== c && d.citySlug !== c) return false;
        return pct >= min;
      });
      countEl.textContent = filtered.length;
      cardsEl.innerHTML = filtered.map(d=>`
        <article class="card">
          <img src="${d.image}" alt="${d.title}" loading="lazy"/>
          <div class="body">
            <div class="badge">-${discount(d.price,d.salePrice)}% Rabais</div>
            <h3>${d.title}</h3>
            <div class="muted">${d.store} · ${d.branch ?? d.city}</div>
            <div class="price"><div class="old">${currency(d.price)}</div><div>${currency(d.salePrice)}</div></div>
            <a class="btn" href="${d.url||'#'}" target="_blank" rel="noopener" style="width:100%">Voir</a>
          </div>
        </article>`).join('');
    }

    function getStoreDefinition(label){
      return STORES.find(store => store.label === label);
    }

    function filePathFor(store, branch){
      const s = store?.slug;
      const c = branch?.slug;
      if(!s || !c) return null;
      return `data/${s}/${c}.json`;
    }

    async function canadianTireHasData(slug){
      if(DEFAULT_BRANCH_SLUGS.has(slug)) return true;
      const path = `data/canadian-tire/${slug}.json`;
      try{
        const head = await fetch(path, {method:'HEAD'});
        if(head.ok) return true;
      }catch(_err){ /* noop */ }
      try{
        const res = await fetch(path, {cache:'no-store'});
        return res.ok;
      }catch(_err){
        return false;
      }
    }

    async function loadCanadianTireDirectory(){
      const store = STORES.find(entry => entry.slug === 'canadian-tire');
      if(!store) return;
      try{
        const res = await fetch('data/canadian-tire/stores.json', {cache:'no-store'});
        if(!res.ok) return;
        const json = await res.json();
        if(!Array.isArray(json)) return;
        const availabilityCache = new Map();
        async function branchHasData(slug){
          if(availabilityCache.has(slug)) return availabilityCache.get(slug);
          const hasData = await canadianTireHasData(slug);
          availabilityCache.set(slug, hasData);
          return hasData;
        }
        const seen = new Map();
        for(const branch of store.branches){
          const slug = branch?.slug;
          if(!slug) continue;
          const hasData = await branchHasData(slug);
          seen.set(slug, {...branch, hasData});
        }
        for(const entry of json){
          const rawSlug = typeof entry.slug === 'string' && entry.slug ? entry.slug : slugify(entry.nickname || entry.city || entry.label);
          if(!rawSlug) continue;
          const label = (entry.nickname || (entry.label || '').replace(/^Canadian Tire\s*/i, '') || entry.city || rawSlug).trim();
          const city = entry.city || label;
          const hasData = await branchHasData(rawSlug);
          const previous = seen.get(rawSlug) || {};
          seen.set(rawSlug, {...previous, label, slug: rawSlug, city, hasData});
        }
        store.branches = Array.from(seen.values()).sort((a,b)=>a.label.localeCompare(b.label,'fr'));
      }catch(err){
        console.warn('Impossible de charger les succursales Canadian Tire', err);
      }
    }

    function setCityOptions(storeLabel, preserveSelection){
      const previous = preserveSelection ? citySelect.value : '';
      let branches;
      if(storeLabel){
        branches = getStoreDefinition(storeLabel)?.branches ?? baseBranches();
      }else{
        branches = baseBranches();
      }
      const options = ['<option value="">(Toutes)</option>'];
      for(const branch of branches){
        const label = branch.hasData === false ? `${branch.label} (bientôt)` : branch.label;
        const attrs = branch.hasData === false ? ' data-empty="true"' : '';
        options.push(`<option value="${branch.slug}"${attrs}>${label}</option>`);
      }
      citySelect.innerHTML = options.join('');
      if(preserveSelection && branches.some(branch => branch.slug === previous)){
        citySelect.value = previous;
      }else{
        citySelect.value = '';
      }
    }

    async function fetchOne(path, storeLabel, branch){
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) return [];
        const json = await res.json();
        if(!Array.isArray(json)) return [];
        return json.map(item => normalizeDeal(item, storeLabel, branch));
      }catch(e){ console.warn('fetch fail', path, e); return []; }
    }

    async function fetchData(){
      deals.length = 0;
      const storeFilter = storeSelect.value;
      const branchFilter = citySelect.value;
      const selectedStores = storeFilter ? [storeFilter] : STORES.map(store => store.label);
      const tasks = [];
      for(const storeLabel of selectedStores){
        const store = getStoreDefinition(storeLabel);
        if(!store) continue;
        let branches = store.branches ?? [];
        if(branchFilter){
          branches = branches.filter(branch => branch.slug === branchFilter);
          if(branches.length === 0) continue;
        }else if(!storeFilter){
          const defaults = branches.filter(branch => DEFAULT_BRANCH_SLUGS.has(branch.slug));
          branches = defaults.length ? defaults : branches;
        }
        if(branches.length === 0){
          branches = store.branches.filter(branch => DEFAULT_BRANCH_SLUGS.has(branch.slug));
        }
        for(const branch of branches){
          if(branch.hasData === false) continue;
          const path = filePathFor(store, branch);
          if(path) tasks.push({store, branch, path});
        }
      }
      const seen = new Set();
      for(const task of tasks){
        if(seen.has(task.path)) continue;
        seen.add(task.path);
        const arr = await fetchOne(task.path, task.store.label, task.branch);
        for(const d of arr){ deals.push(d); }
      }
      render();
    }

    storeSelect.addEventListener('change', () => {
      setCityOptions(storeSelect.value, false);
      fetchData();
    });
    citySelect.addEventListener('change', () => {
      if(postalInput && !normalizePostal(postalInput.value)){
        updatePostalHelper(DEFAULT_POSTAL_MESSAGE, false);
      }
      fetchData();
    });
    range.addEventListener('input', render);
    btnClear.addEventListener('click', ()=>{
      storeSelect.value='';
      setCityOptions('', false);
      citySelect.value='';
      range.value=0;
      resetPostalFilter();
      fetchData();
    });

    // Démarrage
    await loadCanadianTireDirectory();
    storeSelect.value = 'Walmart';
    setCityOptions('Walmart', false);
    citySelect.value = 'saint-jerome';
    range.value = 0; // ← 0% par défaut
    await fetchData();
  });
  </script>
</body>
</html>
