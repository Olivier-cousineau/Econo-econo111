<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EconoDeal — Canada</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb;
      --muted:#9ca3af; --accent:#22c55e; --border:#2b3446; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0b1020 50%,#0a0f1a);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(15,23,42,.85);backdrop-filter: blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    h1{margin:0;font-size:18px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="range"],button{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    input[type="text"],input[type="email"]{width:100%;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .nav-button{display:inline-flex;align-items:center;justify-content:center;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;text-decoration:none;transition:background .2s ease,color .2s ease}
    .nav-button:hover{background:var(--panel);color:#fff}
    .nav-button.current{background:linear-gradient(120deg,rgba(34,197,94,.25),rgba(59,130,246,.25));border-color:rgba(34,197,94,.6)}
    select:focus,input[type="range"]:focus,button:focus,.nav-button:focus{outline:2px solid var(--accent);outline-offset:1px}
    .filters{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px}
    @media (max-width:900px){.filters{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.filters{grid-template-columns:1fr}}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,var(--panel),#0e1626);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .card img{width:100%;height:140px;object-fit:cover;background:#0b0b10}
    .card .body{padding:12px}
    .price{display:flex;gap:10px;align-items:baseline;margin:6px 0}
    .price .old{text-decoration:line-through;color:var(--muted)}
    .badge{display:inline-flex;gap:6px;align-items:center;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac;border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px}
    .section{padding:26px 0}
    .muted{color:var(--muted)}
    .footer{border-top:1px solid var(--border);padding:20px 0;color:var(--muted);text-align:center}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:var(--panel-2);border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:var(--muted)}
    .dev-banner{background:#1f2937;border:1px dashed #ef4444;color:#fecaca;padding:10px 12px;border-radius:10px;margin:12px 0;display:none}
    .pricing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:18px}
    .pricing-card{background:linear-gradient(180deg,var(--panel),#111a2a);border:1px solid var(--border);border-radius:var(--radius);padding:18px;display:flex;flex-direction:column;gap:14px;position:relative;overflow:hidden}
    .pricing-card::before{content:"";position:absolute;inset:0 0 auto 0;height:3px;background:linear-gradient(90deg,rgba(34,197,94,.6),rgba(59,130,246,.6));opacity:.6}
    .pricing-card h4{margin:0;font-size:18px}
    .pricing-price{font-size:26px;font-weight:700;color:#86efac}
    .pricing-features{list-style:none;padding:0;margin:0;display:grid;gap:8px;font-size:14px;color:var(--muted)}
    .pricing-tag{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .pricing-highlight{outline:2px solid rgba(34,197,94,.4);outline-offset:4px;transition:outline-color .3s ease}
    @keyframes pricingPulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}70%{box-shadow:0 0 0 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    #pricing.pricing-pulse{animation:pricingPulse 1.3s ease-out 1}
    .roadmap{background:linear-gradient(180deg,var(--panel),#101b2d);border:1px solid var(--border);border-radius:var(--radius);padding:22px;display:grid;gap:18px;margin-top:22px;position:relative;overflow:hidden}
    .roadmap::before{content:"Roadmap stratégique";position:absolute;top:16px;right:-80px;width:220px;text-align:center;transform:rotate(45deg);background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.35);color:#86efac;padding:6px 0;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .roadmap-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .roadmap-card{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden}
    .roadmap-year{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .roadmap-year strong{display:block;font-size:20px;color:var(--text)}
    .roadmap-card ul{margin:0;padding-left:18px;display:grid;gap:6px;font-size:14px;color:var(--muted)}
    .roadmap-ai{border-left:3px solid var(--accent);padding-left:12px;background:rgba(34,197,94,.08);border-radius:8px}
    @media (max-width:600px){.roadmap::before{right:-120px}}
    #registrationOverlay{position:fixed;inset:0;background:rgba(15,23,42,.95);display:flex;align-items:center;justify-content:center;padding:20px;z-index:2000}
    #registrationOverlay.hidden{display:none}
    .registration-card{background:linear-gradient(180deg,var(--panel),#0e1626);border:1px solid var(--border);border-radius:var(--radius);max-width:420px;width:100%;padding:26px;display:grid;gap:16px;box-shadow:0 24px 60px rgba(15,23,42,.5)}
    .registration-card h2{margin:0}
    .registration-card form{display:grid;gap:12px}
    .checkbox-row{display:flex;gap:10px;align-items:flex-start;background:rgba(34,197,94,.05);border:1px solid rgba(34,197,94,.3);padding:12px;border-radius:10px}
    .checkbox-row input[type="checkbox"]{margin-top:4px}
    .registration-card button{background:linear-gradient(120deg,rgba(34,197,94,.9),rgba(59,130,246,.85));color:#fff;border:none;font-weight:600;cursor:pointer;transition:opacity .2s ease,transform .2s ease}
    .registration-card button:hover:not(:disabled){opacity:.9;transform:translateY(-1px)}
    .registration-card button:disabled{opacity:.45;cursor:not-allowed}
    body.overlay-active{overflow:hidden}
    body.overlay-active header,body.overlay-active main,body.overlay-active .footer{filter:blur(2px);pointer-events:none;user-select:none}
  </style>
</head>
<body class="overlay-active">
  <div id="registrationOverlay" role="dialog" aria-modal="true" aria-labelledby="registrationTitle">
    <div class="registration-card">
      <h2 id="registrationTitle">Accès réservé aux membres</h2>
      <p class="muted" style="margin:0">Rejoignez <strong><span data-client-count>0</span></strong> chasseurs de rabais et accédez au catalogue complet.</p>
      <form id="registrationForm">
        <div>
          <label for="fullName">Nom complet</label>
          <input id="fullName" name="fullName" type="text" placeholder="Entrez votre nom" autocomplete="name" required />
        </div>
        <div>
          <label for="email">Courriel</label>
          <input id="email" name="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
        </div>
        <div class="checkbox-row">
          <input id="regulationCheckbox" name="regulation" type="checkbox" required />
          <label for="regulationCheckbox" style="margin:0">Je confirme avoir lu et accepté les réglementations d'utilisation du site.</label>
        </div>
        <button id="registrationSubmit" type="submit" disabled>S'inscrire et accéder</button>
      </form>
    </div>
  </div>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:10px;align-items:center">
        <h1>EconoDeal</h1>
      </div>
      <div class="row" style="gap:12px;align-items:center">
        <a class="nav-button" href="pricing.html" style="white-space:nowrap">Forfaits / prix</a>
        <a class="nav-button" href="roadmap.html" style="white-space:nowrap">Roadmap / vision</a>
        <div class="muted" style="white-space:nowrap">Clients inscrits&nbsp;: <span data-client-count>0</span></div>
        <div class="muted">© <span id="year"></span></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section" id="search">
      <h2 style="margin:0 0 10px">Trouver des liquidations</h2>
      <p class="muted">Les fichiers sont chargés depuis <span class="kbd">data/&lt;magasin&gt;/&lt;ville&gt;.json</span>.</p>

      <!-- ✅ Les éléments requis existent et leurs IDs correspondent au script -->
      <div class="filters" style="margin-top:12px">
        <div>
          <label for="storeSelect">Magasin</label>
          <select id="storeSelect">
            <option value="">(Tous)</option>
            <option>Home Depot</option>
            <option>Walmart</option>
            <option>Canadian Tire</option>
            <option>Rona</option>
            <option>Patrick Morin</option>
            <option>Sporting Life</option>
          </select>
        </div>
        <div>
          <label for="citySelect">Ville</label>
          <select id="citySelect">
            <option value="">(Toutes)</option>
            <option>Montréal</option>
            <option>Laval</option>
            <option>Saint-Jérôme</option>
          </select>
        </div>
        <div>
          <label for="discountRange">% de rabais minimal : <span id="discountValue" class="kbd">0%</span></label>
          <input id="discountRange" type="range" min="0" max="90" step="5" value="0" />
        </div>
        <div style="align-self:end">
          <button id="btnClear">Réinitialiser</button>
        </div>
      </div>

      <div id="devError" class="dev-banner"></div>

      <div class="section">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Résultats</h3>
          <div class="muted"><span id="resultCount">0</span> articles</div>
        </div>
        <div id="cards" class="grid" style="margin-top:12px"></div>
      </div>
    </section>

    <section class="section" id="pricing" style="padding-top:10px">
      <h2 style="margin:0 0 10px">Forfaits adaptés à vos besoins</h2>
      <p class="muted" style="max-width:620px">Choisissez l'option qui correspond le mieux à votre façon de surveiller les rabais et liquidations au Canada. Chaque forfait inclut une période d'essai de 7 jours.</p>
      <div class="pricing-grid">
        <article class="pricing-card">
          <div class="pricing-tag">Essentiel</div>
          <h4>Accès de base</h4>
          <div class="pricing-price">9,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Accès aux liquidations populaires</li>
            <li>3 alertes courriel par semaine</li>
            <li>Historique de prix sur 30 jours</li>
          </ul>
        </article>
        <article class="pricing-card pricing-highlight">
          <div class="pricing-tag">Le plus populaire</div>
          <h4>Forfait Avancé</h4>
          <div class="pricing-price">19,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Accès illimité au catalogue</li>
            <li>Alertes personnalisées en temps réel</li>
            <li>Listes partagées avec votre équipe</li>
          </ul>
        </article>
        <article class="pricing-card">
          <div class="pricing-tag">Premium</div>
          <h4>Analyse IA complète</h4>
          <div class="pricing-price">29,99&nbsp;$</div>
          <ul class="pricing-features">
            <li>Alertes illimitées multicanal</li>
            <li>Analyse des prix assistée par IA</li>
            <li>Prévisions de tendances du marché</li>
          </ul>
        </article>
      </div>
    </section>

    <section class="section" id="roadmap" style="padding-top:0">
      <h2 style="margin:0 0 10px">Notre feuille de route</h2>
      <p class="muted" style="max-width:640px">Une vision triennale pour propulser EconoDeal sur la scène internationale, avec une intégration progressive de l'intelligence artificielle au cœur de nos services.</p>
      <div class="roadmap">
        <div class="roadmap-grid">
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 1</strong> Canada</div>
            <ul>
              <li>Consolider la couverture des détaillants nationaux.</li>
              <li>Optimiser les alertes de rabais en temps réel.</li>
              <li>Lancer des tableaux de bord régionaux bilingues.</li>
            </ul>
          </article>
          <article class="roadmap-card">
            <div class="roadmap-year"><strong>Année 2</strong> États-Unis</div>
            <ul>
              <li>Élargir le catalogue aux grandes bannières américaines.</li>
              <li>Déployer la surveillance des stocks multi-états.</li>
              <li>Introduire l'analyse prédictive des tendances d'achat.</li>
            </ul>
          </article>
          <article class="roadmap-card roadmap-ai">
            <div class="roadmap-year"><strong>Année 3</strong> Europe</div>
            <ul>
              <li>Localiser l'expérience pour les principaux marchés européens.</li>
              <li>Activer un moteur de recommandations IA multilingue.</li>
              <li>Automatiser les stratégies de prix grâce à l'apprentissage continu.</li>
            </ul>
          </article>
        </div>
      </div>
    </section>
  </main>

  <div class="container footer">
    © <span id="yearFooter"></span> EconoDeal · Tous droits réservés
  </div>

  <script>
  // === Initialisation sûre ===
  document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('registrationOverlay');
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('registrationSubmit');
    const regulationCheckbox = document.getElementById('regulationCheckbox');
    const clientCountDisplays = Array.from(document.querySelectorAll('[data-client-count]'));

    function safeGet(key){
      try{
        return localStorage.getItem(key);
      }catch(err){
        console.warn('Stockage local indisponible', err);
        return null;
      }
    }

    function safeSet(key, value){
      try{
        localStorage.setItem(key, value);
      }catch(err){
        console.warn('Impossible d\'enregistrer les données', err);
      }
    }

    function parseCount(value){
      const parsed = parseInt(value ?? '0', 10);
      return Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
    }

    function getClientCount(){
      return parseCount(safeGet('econodealClientCount'));
    }

    function setClientCount(value){
      safeSet('econodealClientCount', String(Math.max(0, value)));
    }

    function updateClientCountDisplays(){
      const formatter = new Intl.NumberFormat('fr-CA');
      const count = getClientCount();
      clientCountDisplays.forEach(el => {
        el.textContent = formatter.format(count);
      });
    }

    function hideOverlay(){
      if(!overlay) return;
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('overlay-active');
    }

    function showOverlay(){
      if(!overlay) return;
      overlay.classList.remove('hidden');
      overlay.removeAttribute('aria-hidden');
      document.body.classList.add('overlay-active');
      updateClientCountDisplays();
    }

    updateClientCountDisplays();

    const alreadyRegistered = safeGet('econodealClientRegistered') === 'true';
    if(alreadyRegistered){
      hideOverlay();
    }else{
      showOverlay();
    }

    if(submitBtn && regulationCheckbox){
      submitBtn.disabled = !regulationCheckbox.checked;
      regulationCheckbox.addEventListener('change', () => {
        submitBtn.disabled = !regulationCheckbox.checked;
      });
    }

    if(form){
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        if(!form.reportValidity()) return;

        const wasRegistered = safeGet('econodealClientRegistered') === 'true';
        if(!wasRegistered){
          const current = getClientCount();
          setClientCount(current + 1);
        }

        const payload = {
          name: (form.fullName?.value ?? '').trim(),
          email: (form.email?.value ?? '').trim(),
          consent: true,
          registeredAt: new Date().toISOString()
        };

        safeSet('econodealUser', JSON.stringify(payload));
        safeSet('econodealClientRegistered', 'true');
        updateClientCountDisplays();
        hideOverlay();
      });
    }

    const STORES = [
      {label:'Home Depot', slug:'home-depot'},
      {label:'Walmart', slug:'walmart'},
      {label:'Canadian Tire', slug:'canadian-tire'},
      {label:'Rona', slug:'rona'},
      {label:'Patrick Morin', slug:'patrick-morin'},
      {label:'Sporting Life', slug:'sporting-life'}
    ];
    const CITIES = [
      {label:'Montréal', slug:'montreal'},
      {label:'Laval', slug:'laval'},
      {label:'Saint-Jérôme', slug:'saint-jerome'}
    ];

    const storeSelect = document.getElementById('storeSelect');
    const citySelect  = document.getElementById('citySelect');
    const range       = document.getElementById('discountRange');
    const rangeLabel  = document.getElementById('discountValue');
    const cardsEl     = document.getElementById('cards');
    const countEl     = document.getElementById('resultCount');
    const btnClear    = document.getElementById('btnClear');
    const devError    = document.getElementById('devError');

    // Affiche l'année
    const y = new Date().getFullYear();
    document.getElementById('year').textContent = y;
    document.getElementById('yearFooter').textContent = y;

    function toNumber(value){
      if(typeof value === 'number' && Number.isFinite(value)) return value;
      if(typeof value === 'string'){
        const sanitized = value
          .replace(/[^0-9,.-]/g,'')
          .replace(/,(?=[^,]*,)/g,'')
          .replace(',','.');
        const num = Number(sanitized);
        return Number.isFinite(num) ? num : null;
      }
      return null;
    }

    function firstDefined(...values){
      for(const value of values){
        if(value !== undefined && value !== null && value !== '') return value;
      }
      return null;
    }

    function normalizeDeal(item, storeLabel, cityLabel){
      const regular = toNumber(firstDefined(
        item.original_price,
        item.originalPrice,
        item.regular_price,
        item.regularPrice,
        item.price_before,
        item.priceBefore,
        item.listPrice,
        item.price // fallback when only one price exists
      ));

      const sale = toNumber(firstDefined(
        item.salePrice,
        item.sale_price,
        item.discount_price,
        item.discountPrice,
        item.current_price,
        item.currentPrice,
        // When only price and original exist, price is the reduced amount
        item.price
      ));

      const finalRegular = regular ?? sale ?? 0;
      const finalSale = sale ?? regular ?? 0;

      return {
        title: firstDefined(item.title, item.name, 'Article en liquidation'),
        image: firstDefined(item.image, item.image_url, item.imageUrl, item.img, 'https://via.placeholder.com/400x300?text=Liquidation'),
        price: finalRegular,
        salePrice: finalSale,
        store: item.store ?? storeLabel,
        city: item.city ?? cityLabel,
        url: firstDefined(item.url, item.link, '#')
      };
    }

    function discount(p,s){
      if(!p || !s || !Number.isFinite(p) || !Number.isFinite(s) || p === 0) return 0;
      const pct = Math.round((1 - (s / p)) * 100);
      return Number.isFinite(pct) ? Math.max(pct, 0) : 0;
    }
    function currency(n){ return n.toLocaleString('fr-CA',{style:'currency',currency:'CAD'}); }

    const deals = [];

    function render(){
      rangeLabel.textContent = range.value + '%';
      const s=storeSelect.value, c=citySelect.value, min=parseInt(range.value,10);
      const filtered=deals.filter(d=>{
        const pct=discount(d.price,d.salePrice);
        return(!s||d.store===s)&&(!c||d.city===c)&&pct>=min
      });
      countEl.textContent = filtered.length;
      cardsEl.innerHTML = filtered.map(d=>`
        <article class="card">
          <img src="${d.image}" alt="${d.title}" loading="lazy"/>
          <div class="body">
            <div class="badge">-${discount(d.price,d.salePrice)}% Rabais</div>
            <h3>${d.title}</h3>
            <div class="muted">${d.store} · ${d.city}</div>
            <div class="price"><div class="old">${currency(d.price)}</div><div>${currency(d.salePrice)}</div></div>
            <a class="btn" href="${d.url||'#'}" target="_blank" rel="noopener" style="width:100%">Voir</a>
          </div>
        </article>`).join('');
    }

    function filePathFor(storeLabel, cityLabel){
      const s = (STORES.find(x=>x.label===storeLabel)||{}).slug;
      const c = (CITIES.find(x=>x.label===cityLabel)||{}).slug;
      if(!s || !c) return null;
      return `data/${s}/${c}.json`;
    }

    async function fetchOne(path, storeLabel, cityLabel){
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) return [];
        const json = await res.json();
        if(!Array.isArray(json)) return [];
        return json.map(item => normalizeDeal(item, storeLabel, cityLabel));
      }catch(e){ console.warn('fetch fail', path, e); return []; }
    }

    async function fetchData(){
      deals.length = 0;
      const stores = storeSelect.value ? [storeSelect.value] : STORES.map(s=>s.label);
      const cities = citySelect.value  ? [citySelect.value]  : CITIES.map(c=>c.label);
      for(const s of stores){ for(const c of cities){
        const path = filePathFor(s,c);
        if(!path) continue;
        const arr = await fetchOne(path, s, c);
        for(const d of arr){ deals.push(d); }
      }}
      render();
    }

    storeSelect.addEventListener('change', fetchData);
    citySelect.addEventListener('change', fetchData);
    range.addEventListener('input', render);
    btnClear.addEventListener('click', ()=>{ storeSelect.value=''; citySelect.value=''; range.value=0; fetchData(); });

    // Démarrage
    storeSelect.value = 'Walmart';
    citySelect.value  = 'Saint-Jérôme';
    range.value = 0; // ← 0% par défaut
    fetchData();
  });
  </script>
</body>
</html>
