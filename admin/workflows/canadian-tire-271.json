{
  "name": "canadian-tire-271-liquidation",
  "description": "Scrape liquidation listings and product data for Canadian Tire store 271.",
  "entry_stage": "listing",
  "stages": [
    {
      "id": "listing",
      "label": "Listing",
      "type": "interaction",
      "script": {
        "language": "javascript",
        "interaction": "// INPUT: { url: \"https://www.canadiantire.ca/fr/promotions/liquidation.html?store=271\" }\nnavigate(input.url);\n\n// 1) attendre qu'au moins un type de carte apparaisse\nconst CARD_A = \"li[data-testid='product-grids']\";\nconst CARD_B = \"li[data-qa='product-grid-item']\";\nwait(`${CARD_A}, ${CARD_B}`);\n\n// 2) parser la page courante pour récupérer les URLs produits (le Parser ci-dessous renvoie {urls: [...]})\nlet page_data = parse();\nconsole.log(`Found ${page_data.urls.length} products on current page`);\n\n// 3) envoyer chaque URL à l'étape suivante (on s’assure que le store est présent)\nfor (let url of page_data.urls) {\n  let u = url.includes(\"store=\") ? url : (url + (url.includes(\"?\") ? \"&\" : \"?\") + \"store=271\");\n  next_stage({ url: u });\n}\n\n// 4) pagination: bouton \"Charger plus\" OU \"Suivant\"\nconst LOAD_MORE = \"button:has-text('Charger plus'), button:has-text('Voir plus')\";\nconst NEXT_BTN  = \"a[rel='next'], button[aria-label*='Suivant'], a[aria-label*='Suivant'], a[aria-label*='Next']\";\n\nif (el_exists(LOAD_MORE) && !attr(LOAD_MORE, \"disabled\")) {\n  console.log(\"Click LOAD_MORE…\");\n  click(LOAD_MORE);\n  wait(`${CARD_A}, ${CARD_B}`);\n  // relance cette étape pour la page suivante\n  rerun_stage({ url: location.href });\n} else if (el_exists(NEXT_BTN) && !attr(NEXT_BTN, \"disabled\")) {\n  console.log(\"Click NEXT…\");\n  click(NEXT_BTN);\n  wait(`${CARD_A}, ${CARD_B}`);\n  rerun_stage({ url: location.href });\n} else {\n  console.log(\"No more pages.\");\n  set_output({ status: \"done\" });\n}",
        "parser": "// Renvoie toutes les URLs de fiches produits sur la page\nconst anchors = queryAll(\"a[href*='/pdp/'], a[href*='/product/']\");\nconst urls = [];\nfor (let a of anchors) {\n  const href = attr(a, \"href\");\n  if (!href) continue;\n  let u = href.startsWith(\"http\") ? href : absolute_url(href);\n  if (!u.includes(\"/pdp/\") && !u.includes(\"/product/\")) continue;\n  urls.push(u.split(\"#\")[0]); // nettoie les #ancres\n}\nreturn { urls: Array.from(new Set(urls)) };"
      },
      "transitions": [
        {
          "on": "default",
          "to": "pdp"
        }
      ],
      "default_input": {
        "url": "https://www.canadiantire.ca/fr/promotions/liquidation.html?store=271"
      }
    },
    {
      "id": "pdp",
      "label": "Product Detail",
      "type": "interaction",
      "script": {
        "language": "javascript",
        "interaction": "// INPUT: { url: \"<URL fiche produit avec ?store=271>\" }\nnavigate(input.url);\nwait(\"body\");\nsleep(800); // laisser respirer les scripts prix\n\nlet pdp = parse();\n\n// Si pas de prix, scroll + re-parse\nif (!pdp.price_now && !pdp.price_was) {\n  scroll_to(0, 1200);\n  sleep(800);\n  const retry = parse();\n  if (retry.price_now || retry.price_was) {\n    set_output(retry);\n  } else {\n    set_output(pdp);\n  }\n} else {\n  set_output(pdp);\n}",
        "parser": "function num(x) {\n  if (!x) return null;\n  const m = String(x).replace(/ /g, \" \").match(/(\\d{1,5}(?:[.,]\\d{2})?)/);\n  return m ? parseFloat(m[1].replace(\",\", \".\")) : null;\n}\n\nlet price_now = null, price_was = null, currency = \"CAD\";\n\n// 1) JSON-LD (souvent fiable)\nconst jsonlds = queryAll(\"script[type='application/ld+json']\");\nfor (let s of jsonlds) {\n  try {\n    const obj = JSON.parse(text(s));\n    const arr = Array.isArray(obj) ? obj : [obj];\n    for (let o of arr) {\n      if (o && (o[\"@type\"] === \"Product\" || o[\"@type\"] === \"Offer\")) {\n        const offers = o.offers || o;\n        if (offers) {\n          if (offers.price) price_now = price_now ?? num(offers.price);\n          if (offers.priceCurrency) currency = offers.priceCurrency;\n        }\n      }\n    }\n  } catch (e) {}\n}\n\n// 2) Fallback DOM — prix actuel & prix \"était\"\nprice_now = price_now ??\n  num(text(\".nl-price--total--red\")) ??\n  num(text(\".nl-price--total\")) ??\n  num(text(\"[data-automation='sale-price']\")) ??\n  num(text(\"[data-automation='current-price']\"));\n\nprice_was =\n  num(text(\".nl-price--was\")) ??\n  num(text(\".sr-only\")) ??\n  num(text(\"[data-automation='was-price']\"));\n\n// 3) autres champs\nconst title = text(\"h1, [data-automation='product-title'], .pdp-product-title\") || \"\";\nconst image = attr(\"img[alt][src*='product'], img[loading='eager']\", \"src\") || \"\";\nconst sku = (text(\"[data-automation='product-code'], .product__code\") || \"\").replace(/^#/, \"\").trim();\nconst availability = text(\"[data-automation='availability'], .availability, .store-availability\") || \"\";\nconst brand = text(\"[data-automation='brand'], .product-brand, .brand\") || \"\";\nconst tag = (text(\".badge, .nl-rebate-header, .product-badge\") || \"\").trim() || \"\";\n\n// 4) rabais\nlet discount_pct = null;\nif (price_now != null && price_was != null && price_was > 0 && price_now <= price_was) {\n  discount_pct = Math.round(((price_was - price_now) / price_was) * 100);\n}\n\nreturn {\n  title,\n  brand,\n  price_now,\n  price_was,\n  discount_pct,\n  currency,\n  availability,\n  image,\n  sku,\n  link: url(),\n  tag\n};"
      }
    }
  ],
  "output": {
    "format": "json",
    "schema": {
      "type": "object",
      "properties": {
        "title": {
          "type": [
            "string",
            "null"
          ]
        },
        "brand": {
          "type": [
            "string",
            "null"
          ]
        },
        "price_now": {
          "type": [
            "number",
            "null"
          ]
        },
        "price_was": {
          "type": [
            "number",
            "null"
          ]
        },
        "discount_pct": {
          "type": [
            "number",
            "null"
          ]
        },
        "currency": {
          "type": [
            "string",
            "null"
          ]
        },
        "availability": {
          "type": [
            "string",
            "null"
          ]
        },
        "image": {
          "type": [
            "string",
            "null"
          ]
        },
        "sku": {
          "type": [
            "string",
            "null"
          ]
        },
        "link": {
          "type": [
            "string",
            "null"
          ]
        },
        "tag": {
          "type": [
            "string",
            "null"
          ]
        }
      }
    }
  }
}
