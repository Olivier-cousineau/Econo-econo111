<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EconoDeal ‚Äî Acc√®s aux inscriptions</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb;
      --muted:#9ca3af; --accent:#22c55e; --border:#2b3446; --radius:14px;
      --danger:#f87171;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg),#0b1020 50%,#0a0f1a);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      border-bottom:1px solid var(--border);
      background:rgba(15,23,42,.85);
      backdrop-filter:blur(8px);
      position:sticky;
      top:0;
      z-index:10;
    }
    .container{max-width:1000px;margin:0 auto;padding:18px}
    .breadcrumb{font-size:14px;color:var(--muted)}
    h1{margin:12px 0;font-size:26px}
    p{color:var(--muted);max-width:720px}
    main{flex:1;width:100%}
    table{width:100%;border-collapse:collapse;background:var(--panel-2);border-radius:var(--radius);overflow:hidden}
    thead{background:rgba(34,197,94,.08)}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);font-size:14px}
    th{font-weight:600;color:#bbf7d0}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:nth-child(even){background:rgba(15,23,42,.35)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(34,197,94,.18);color:#86efac;font-size:12px}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin:20px 0}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:20px 0}
    .metric-card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:grid;gap:6px;box-shadow:0 16px 36px rgba(8,13,26,.45)}
    .metric-label{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);font-weight:600}
    .metric-value{font-size:28px;font-weight:700;color:#bbf7d0}
    .metric-detail{font-size:13px;color:var(--muted);line-height:1.5}
    .active-client{display:grid;gap:4px}
    .active-client strong{font-size:16px;color:#fff}
    .active-client a{color:inherit;text-decoration:none;font-weight:600}
    .active-client time{font-size:12px;color:var(--muted)}
    button{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer;transition:background .2s ease,color .2s ease}
    button:hover{background:var(--panel-2)}
    .muted{color:var(--muted)}
    .empty{margin:30px 0;padding:22px;border:1px dashed var(--border);border-radius:var(--radius);text-align:center;color:var(--muted)}
    footer{border-top:1px solid var(--border);padding:18px 0;color:var(--muted);text-align:center;font-size:14px}

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.96);display:flex;align-items:center;justify-content:center;padding:20px;z-index:200}
    .overlay.hidden{display:none}
    .overlay-card{background:linear-gradient(180deg,var(--panel),#0e1626);border:1px solid var(--border);border-radius:var(--radius);max-width:360px;width:100%;padding:26px;display:grid;gap:16px;box-shadow:0 24px 60px rgba(15,23,42,.45)}
    .overlay h2{margin:0}
    .overlay form{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type="password"]{width:100%;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    .error{color:var(--danger);font-size:13px;min-height:18px}
  </style>
</head>
<body>
  <div id="accessOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
    <div class="overlay-card">
      <h2 id="overlayTitle">Espace s√©curis√©</h2>
      <p class="muted" style="margin:0">Entrez le mot de passe administrateur pour consulter la liste des inscriptions.</p>
      <form id="accessForm">
        <div>
          <label for="adminPassword">Mot de passe</label>
          <input id="adminPassword" name="password" type="password" autocomplete="current-password" required />
        </div>
        <div class="error" id="accessError" aria-live="assertive"></div>
        <button type="submit">D√©verrouiller</button>
      </form>
    </div>
  </div>

  <header>
    <div class="container">
      <div class="breadcrumb">üè† <a href="../index.html" style="color:inherit;text-decoration:none">Retour √† l'accueil</a> ¬∑ Acc√®s priv√©</div>
      <h1>Inscriptions des membres</h1>
      <p>Cette page affiche les contacts collect√©s via le formulaire d'inscription. Le contenu est stock√© localement sur le navigateur utilis√©. Pour une s√©curit√© renforc√©e, changez le mot de passe dans ce fichier apr√®s chaque partage.</p>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="actions">
        <span class="badge"><strong id="entryCount">0</strong>&nbsp;inscriptions</span>
        <button id="btnRefresh" type="button">Actualiser</button>
        <button id="btnExport" type="button">Exporter en CSV</button>
        <button id="btnManual" type="button">Partir manuellement</button>
      </div>
      <div class="metrics" role="list">
        <article class="metric-card" role="listitem">
          <span class="metric-label">Clients inscrits</span>
          <span class="metric-value" id="metricTotalValue">0</span>
          <p class="metric-detail">Nombre total de contacts uniques stock√©s sur ce navigateur.</p>
        </article>
        <article class="metric-card" role="listitem">
          <span class="metric-label">Client actuellement actif</span>
          <div id="activeClient" class="metric-detail"><span class="muted">Aucun client actif enregistr√©.</span></div>
        </article>
      </div>
      <div id="tableWrapper"></div>
    </div>
  </main>

  <footer>
    ¬© <span id="year"></span> EconoDeal ‚Äî Acc√®s r√©serv√©
  </footer>

  <script>
    const PASSWORD_HASH = '6136659243031c1b1d6c142aba3ee6b3ce0f2a1097a9e4a0b1bd11b54845e01c';

    const overlay = document.getElementById('accessOverlay');
    const form = document.getElementById('accessForm');
    const passwordInput = document.getElementById('adminPassword');
    const errorEl = document.getElementById('accessError');
    const tableWrapper = document.getElementById('tableWrapper');
    const countEl = document.getElementById('entryCount');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnExport = document.getElementById('btnExport');
    const btnManual = document.getElementById('btnManual');
    const metricTotalValue = document.getElementById('metricTotalValue');
    const activeClientEl = document.getElementById('activeClient');

    document.getElementById('year').textContent = new Date().getFullYear();

    function safeRead(key){
      try{
        return localStorage.getItem(key);
      }catch(err){
        console.warn('Lecture impossible', err);
        return null;
      }
    }

    function parseJson(value){
      if(!value) return null;
      try{
        return JSON.parse(value);
      }catch(err){
        console.warn('JSON invalide', err);
        return null;
      }
    }

    function formatDate(value){
      if(!value) return '';
      const date = new Date(value);
      if(Number.isNaN(date.getTime())) return value;
      return new Intl.DateTimeFormat('fr-CA', {
        dateStyle:'medium',
        timeStyle:'short'
      }).format(date);
    }

    function splitNames(name){
      const parts = (name || '')
        .split(/\s+/)
        .map(part => part.trim())
        .filter(Boolean);
      if(parts.length === 0){
        return { firstName:'', lastName:'' };
      }
      const [firstName, ...rest] = parts;
      return {
        firstName,
        lastName: rest.join(' ')
      };
    }

    function sanitizeEntry(entry){
      if(!entry || typeof entry !== 'object') return null;
      const name = typeof entry.name === 'string' ? entry.name.trim() : '';
      const email = typeof entry.email === 'string' ? entry.email.trim().toLowerCase() : '';
      if(!email) return null;
      return {
        name,
        email,
        registeredAt: typeof entry.registeredAt === 'string' ? entry.registeredAt : ''
      };
    }

    function getRegistrations(){
      const parsed = parseJson(safeRead('econodealRegistrations'));
      if(!Array.isArray(parsed)) return [];
      return parsed
        .map(sanitizeEntry)
        .filter(Boolean)
        .sort((a,b) => (a.registeredAt > b.registeredAt ? -1 : 1));
    }

    function dedupeEntries(entries){
      if(!Array.isArray(entries)) return [];
      const byEmail = new Map();
      entries.forEach(entry => {
        if(!entry?.email) return;
        const existing = byEmail.get(entry.email);
        if(!existing){
          byEmail.set(entry.email, entry);
          return;
        }
        const currentDate = Date.parse(entry.registeredAt ?? '');
        const existingDate = Date.parse(existing.registeredAt ?? '');
        if(Number.isFinite(currentDate) && (!Number.isFinite(existingDate) || currentDate > existingDate)){
          byEmail.set(entry.email, entry);
          return;
        }
        if(!Number.isFinite(currentDate) && !Number.isFinite(existingDate) && entry.name && !existing.name){
          byEmail.set(entry.email, entry);
        }
      });
      return Array.from(byEmail.values()).sort((a,b) => {
        const dateA = Date.parse(a?.registeredAt ?? '') || 0;
        const dateB = Date.parse(b?.registeredAt ?? '') || 0;
        return dateB - dateA;
      });
    }

    function renderMetrics(entries){
      const safeEntries = Array.isArray(entries) ? entries : [];
      const formatter = new Intl.NumberFormat('fr-CA');
      if(metricTotalValue){
        metricTotalValue.textContent = formatter.format(safeEntries.length);
      }
      if(activeClientEl){
        if(safeEntries.length === 0){
          activeClientEl.innerHTML = '<span class="muted">Aucun client actif enregistr√©.</span>';
          return;
        }
        const active = safeEntries[0];
        const parts = splitNames(active.name);
        const displayName = [parts.firstName, parts.lastName].filter(Boolean).join(' ').trim();
        const name = displayName || active.email || 'Client confirm√©';
        const emailLink = active.email ? `<a href="mailto:${active.email}">${active.email}</a>` : '';
        const formattedDate = formatDate(active.registeredAt);
        const dateText = formattedDate ? `<time datetime="${active.registeredAt}">${formattedDate}</time>` : '';
        activeClientEl.innerHTML = `
          <div class="active-client">
            <strong>${name}</strong>
            ${emailLink ? `<span>${emailLink}</span>` : ''}
            ${dateText}
          </div>
        `;
      }
    }

    function renderTable(){
      const entries = dedupeEntries(getRegistrations());
      countEl.textContent = entries.length.toString();
      renderMetrics(entries);

      if(entries.length === 0){
        tableWrapper.innerHTML = '<div class="empty">Aucune inscription n\'est enregistr√©e sur ce navigateur.</div>';
        return;
      }

      const rows = entries.map(entry => {
        const parts = splitNames(entry.name);
        const firstName = parts.firstName || '‚Äî';
        const lastName = parts.lastName || '‚Äî';
        const registered = formatDate(entry.registeredAt) || '‚Äî';
        return `
          <tr>
            <td>${firstName}</td>
            <td>${lastName}</td>
            <td><a href="mailto:${entry.email}" style="color:inherit">${entry.email}</a></td>
            <td>${registered}</td>
          </tr>
        `;
      }).join('');

      tableWrapper.innerHTML = `
        <div style="overflow:auto;border-radius:var(--radius);border:1px solid var(--border)">
          <table>
            <thead>
              <tr>
                <th>Pr√©nom</th>
                <th>Nom</th>
                <th>Courriel</th>
                <th>Date d'inscription</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function toCSV(entries){
      const header = ['prenom','nom','courriel','date_inscription'];
      const lines = entries.map(entry => {
        const parts = splitNames(entry.name);
        const values = [parts.firstName, parts.lastName, entry.email, entry.registeredAt];
        return values.map(value => {
          const safe = (value || '').replace(/"/g,'""');
          return `"${safe}"`;
        }).join(',');
      });
      return [header.join(','), ...lines].join('\n');
    }

    function downloadCSV(){
      const entries = dedupeEntries(getRegistrations());
      if(entries.length === 0){
        alert('Aucune inscription √† exporter.');
        return;
      }
      const blob = new Blob([toCSV(entries)], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `inscriptions-econodeal-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function promptManualRegistration(){
      const nameInput = window.prompt('Nom complet du contact ?');
      if(nameInput === null) return;
      const emailInput = window.prompt('Courriel du contact ?');
      if(emailInput === null) return;

      const sanitized = sanitizeEntry({
        name: nameInput,
        email: emailInput,
        registeredAt: new Date().toISOString()
      });

      if(!sanitized){
        alert('Le courriel est requis pour cr√©er une inscription.');
        return;
      }

      const existingRaw = parseJson(safeRead('econodealRegistrations'));
      const nextEntries = Array.isArray(existingRaw)
        ? existingRaw.filter(entry => entry && typeof entry === 'object')
        : [];
      nextEntries.push(sanitized);

      try{
        localStorage.setItem('econodealRegistrations', JSON.stringify(nextEntries));
      }catch(err){
        console.error('Impossible d\'enregistrer l\'inscription manuelle', err);
        alert('Impossible d\'enregistrer l\'inscription manuelle. V√©rifiez l\'espace de stockage du navigateur.');
        return;
      }

      renderTable();
      alert('Inscription manuelle ajout√©e.');
    }

    async function hashValue(value){
      const encoder = new TextEncoder();
      const data = encoder.encode(value);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function verifyPassword(password){
      const digest = await hashValue(password);
      return digest === PASSWORD_HASH;
    }

    function unlock(){
      overlay.classList.add('hidden');
      document.body.classList.remove('locked');
      renderTable();
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      errorEl.textContent = '';
      const password = passwordInput.value.trim();
      if(!password){
        errorEl.textContent = 'Veuillez entrer le mot de passe.';
        return;
      }
      form.querySelector('button[type="submit"]').disabled = true;
      try{
        const valid = await verifyPassword(password);
        if(valid){
          unlock();
        }else{
          errorEl.textContent = 'Mot de passe invalide.';
          form.querySelector('button[type="submit"]').disabled = false;
          passwordInput.value = '';
          passwordInput.focus();
        }
      }catch(err){
        console.error('Erreur de v√©rification', err);
        errorEl.textContent = 'Une erreur est survenue. R√©essayez.';
        form.querySelector('button[type="submit"]').disabled = false;
      }
    });

    btnRefresh.addEventListener('click', renderTable);
    btnExport.addEventListener('click', downloadCSV);
    if(btnManual){
      btnManual.addEventListener('click', promptManualRegistration);
    }
  </script>
</body>
</html>
