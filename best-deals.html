<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EconoDeal — Meilleurs rabais</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb;
      --muted:#9ca3af; --accent:#22c55e; --border:#2b3446; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0b1020 50%,#0a0f1a);color:var(--text)}
    header{position:sticky;top:0;z-index:20;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .brand{display:inline-flex;align-items:center;gap:12px;padding:6px 14px;border-radius:14px;text-decoration:none;color:var(--text);background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.35);transition:transform .2s ease,box-shadow .2s ease,background .2s ease}
    .brand:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(34,197,94,.15);background:rgba(34,197,94,.12)}
    .brand img{width:46px;height:46px;display:block}
    .brand-text{display:flex;flex-direction:column;line-height:1.1}
    .brand-title{margin:0;font-size:18px;font-weight:700;letter-spacing:-.01em}
    .brand-tagline{font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:#86efac;font-weight:600}
    h2{margin:0;font-size:24px}
    .nav-button{display:inline-flex;align-items:center;justify-content:center;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;text-decoration:none;transition:background .2s ease,color .2s ease}
    .nav-button:hover{background:var(--panel);color:#fff}
    .nav-button:focus{outline:2px solid var(--accent);outline-offset:1px}
    .nav-button.current{background:linear-gradient(120deg,rgba(34,197,94,.25),rgba(59,130,246,.25));border-color:rgba(34,197,94,.6)}
    .badge{display:inline-flex;gap:6px;align-items:center;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac;border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px}
    .muted{color:var(--muted)}
    .section{padding:26px 0}
    .hero{display:grid;gap:12px}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    select:focus,button:focus{outline:2px solid var(--accent);outline-offset:1px}
    button{cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,var(--panel),#0e1626);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:140px;object-fit:cover;background:#0b0b10}
    .card .body{padding:12px;display:grid;gap:8px;flex:1}
    .card h3{margin:0;font-size:16px;line-height:1.4}
    .price{display:flex;gap:10px;align-items:baseline}
    .price .old{text-decoration:line-through;color:var(--muted)}
    .footer{border-top:1px solid var(--border);padding:20px 0;color:var(--muted);text-align:center}
    .status-banner{display:flex;gap:10px;align-items:center;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.35);color:#bfdbfe;padding:10px 12px;border-radius:10px;font-size:13px}
    .status-banner.error{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.4);color:#fecaca}
    .empty{border:1px dashed var(--border);padding:30px;border-radius:var(--radius);text-align:center;color:var(--muted)}
    @media (max-width:640px){
      header{position:static}
      .hero{gap:16px}
      .card img{height:180px}
    }
  </style>
</head>
<body class="overlay-active">
  <div id="registrationOverlay" role="dialog" aria-modal="true" aria-labelledby="registrationTitle">
    <div class="registration-card">
      <h2 id="registrationTitle">Accès réservé aux membres</h2>
      <p class="muted" style="margin:0">Rejoignez <strong><span data-client-count>0</span></strong> chasseurs de rabais et accédez au classement des meilleures offres.</p>
      <form id="registrationForm">
        <div>
          <label for="fullName">Nom complet</label>
          <input id="fullName" name="fullName" type="text" placeholder="Entrez votre nom" autocomplete="name" required />
        </div>
        <div>
          <label for="email">Courriel</label>
          <input id="email" name="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
        </div>
        <div class="checkbox-row">
          <input id="regulationCheckbox" name="regulation" type="checkbox" required />
          <label for="regulationCheckbox" style="margin:0">Je confirme avoir lu et accepté les réglementations d'utilisation du site.</label>
        </div>
        <button id="registrationSubmit" type="submit" disabled>S'inscrire et accéder</button>
      </form>
    </div>
  </div>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:10px;align-items:center">
        <a class="brand" href="index.html">
          <img src="assets/logo.svg" alt="EconoDeal – accélérateur de revendeurs" />
          <span class="brand-text">
            <span class="brand-title">EconoDeal</span>
            <span class="brand-tagline">Revendeur gagnant</span>
          </span>
        </a>
      </div>
      <div class="row" style="gap:12px;align-items:center">
        <a class="nav-button current" href="best-deals.html" style="white-space:nowrap">Meilleurs rabais</a>
        <a class="nav-button" href="pricing.html" style="white-space:nowrap">Forfaits / prix</a>
        <a class="nav-button" href="roadmap.html" style="white-space:nowrap">Roadmap / vision</a>
        <div class="muted" style="white-space:nowrap">Clients inscrits&nbsp;: <span data-client-count>0</span></div>
        <div class="muted">© <span id="year"></span></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section" style="padding-bottom:10px">
      <div class="hero">
        <div class="badge">Mise à jour après chaque collecte</div>
        <h2>Classement des meilleures liquidations</h2>
        <p class="muted" style="max-width:720px">Découvrez les rabais les plus agressifs détectés par nos robots sur l'ensemble des détaillants surveillés. Le classement se rafraîchit automatiquement dès que les scrapers terminent leur collecte. Rechargez la page pour voir les dernières offres et consultez le top 100 des meilleures liquidations triées par pourcentage de rabais.</p>
        <div class="status-banner" id="statusBanner" role="status">
          <span id="statusText">Analyse des dernières collectes en cours...</span>
        </div>
        <div class="filters">
          <div>
            <label for="storeFilter" class="muted" style="font-size:12px;display:block;margin-bottom:4px">Filtrer par détaillant</label>
            <select id="storeFilter">
              <option value="">Tous les détaillants</option>
            </select>
          </div>
          <div style="margin-left:auto" class="muted">Total&nbsp;: <span id="dealCount">0</span> offres</div>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top:12px">
      <div id="cards" class="grid" aria-live="polite"></div>
      <div id="emptyState" class="empty" style="display:none">Aucune liquidation trouvée pour le moment. Réessayez plus tard!</div>
    </section>
  </main>

  <div class="container footer">
    © <span id="yearFooter"></span> EconoDeal · Tous droits réservés
  </div>

  <style>
    /* Compléments stylistiques partagés avec l'accueil */
    #registrationOverlay{position:fixed;inset:0;background:rgba(15,23,42,.95);display:flex;align-items:center;justify-content:center;padding:20px;z-index:2000}
    #registrationOverlay.hidden{display:none}
    .registration-card{background:linear-gradient(180deg,var(--panel),#0e1626);border:1px solid var(--border);border-radius:var(--radius);max-width:420px;width:100%;padding:26px;display:grid;gap:16px;box-shadow:0 24px 60px rgba(15,23,42,.5)}
    .registration-card form{display:grid;gap:12px}
    .registration-card input{width:100%;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .registration-card button{background:linear-gradient(120deg,rgba(34,197,94,.9),rgba(59,130,246,.85));color:#fff;border:none;font-weight:600;cursor:pointer;transition:opacity .2s ease,transform .2s ease}
    .registration-card button:hover:not(:disabled){opacity:.9;transform:translateY(-1px)}
    .checkbox-row{display:flex;gap:10px;align-items:flex-start;background:rgba(34,197,94,.05);border:1px solid rgba(34,197,94,.3);padding:12px;border-radius:10px}
    body.overlay-active{overflow:hidden}
    body.overlay-active header,body.overlay-active main,body.overlay-active .footer{filter:blur(2px);pointer-events:none;user-select:none}
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const overlay = document.getElementById('registrationOverlay');
      const form = document.getElementById('registrationForm');
      const submitBtn = document.getElementById('registrationSubmit');
      const regulationCheckbox = document.getElementById('regulationCheckbox');
      const clientCountDisplays = Array.from(document.querySelectorAll('[data-client-count]'));
      const statusBanner = document.getElementById('statusBanner');
      const statusText = document.getElementById('statusText');
      const cardsEl = document.getElementById('cards');
      const emptyState = document.getElementById('emptyState');
      const storeFilter = document.getElementById('storeFilter');
      const dealCount = document.getElementById('dealCount');
      const year = document.getElementById('year');
      const yearFooter = document.getElementById('yearFooter');
      const currentYear = new Date().getFullYear();
      if(year) year.textContent = currentYear;
      if(yearFooter) yearFooter.textContent = currentYear;

      function parseJson(value){
        if(!value) return null;
        try{ return JSON.parse(value); }
        catch(err){ console.warn('Impossible de lire les données existantes', err); return null; }
      }
      function safeGet(key){
        try{ return localStorage.getItem(key); }
        catch(err){ console.warn('Stockage local indisponible', err); return null; }
      }
      function safeSet(key, value){
        try{ localStorage.setItem(key, value); }
        catch(err){ console.warn('Impossible d\'enregistrer les données', err); }
      }
      function cleanText(value){ return typeof value === 'string' ? value.trim() : ''; }
      function getRegistrations(){
        const parsed = parseJson(safeGet('econodealRegistrations'));
        if(!Array.isArray(parsed)) return [];
        return parsed
          .filter(item => item && typeof item === 'object')
          .map(item => ({
            name: cleanText(item.name),
            email: cleanText(item.email).toLowerCase(),
            registeredAt: cleanText(item.registeredAt)
          }))
          .filter(item => item.email);
      }
      function saveRegistrations(items){ safeSet('econodealRegistrations', JSON.stringify(items)); }
      function upsertRegistration(entry){
        const collection = getRegistrations();
        const email = cleanText(entry.email).toLowerCase();
        if(!email) return;
        const normalized = {
          name: cleanText(entry.name),
          email,
          registeredAt: cleanText(entry.registeredAt)
        };
        const existingIndex = collection.findIndex(item => item.email === email);
        if(existingIndex >= 0){ collection[existingIndex] = {...collection[existingIndex], ...normalized}; }
        else{ collection.push(normalized); }
        saveRegistrations(collection);
      }
      function parseCount(value){
        const parsed = parseInt(value ?? '0', 10);
        return Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
      }
      function getClientCount(){ return parseCount(safeGet('econodealClientCount')); }
      function setClientCount(value){ safeSet('econodealClientCount', String(Math.max(0, value))); }
      function updateClientCountDisplays(){
        const formatter = new Intl.NumberFormat('fr-CA');
        const count = getClientCount();
        clientCountDisplays.forEach(el => { el.textContent = formatter.format(count); });
      }
      function hideOverlay(){ if(!overlay) return; overlay.classList.add('hidden'); overlay.setAttribute('aria-hidden','true'); document.body.classList.remove('overlay-active'); }
      function showOverlay(){ if(!overlay) return; overlay.classList.remove('hidden'); overlay.removeAttribute('aria-hidden'); document.body.classList.add('overlay-active'); updateClientCountDisplays(); }
      updateClientCountDisplays();
      const alreadyRegistered = safeGet('econodealClientRegistered') === 'true';
      if(alreadyRegistered){ hideOverlay(); }
      else{ showOverlay(); }
      if(submitBtn && regulationCheckbox){
        submitBtn.disabled = !regulationCheckbox.checked;
        regulationCheckbox.addEventListener('change', () => { submitBtn.disabled = !regulationCheckbox.checked; });
      }
      if(form){
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          if(!form.reportValidity()) return;
          const wasRegistered = safeGet('econodealClientRegistered') === 'true';
          if(!wasRegistered){
            const current = getClientCount();
            setClientCount(current + 1);
          }
          const payload = {
            name: (form.fullName?.value ?? '').trim(),
            email: (form.email?.value ?? '').trim(),
            consent: true,
            registeredAt: new Date().toISOString()
          };
          safeSet('econodealUser', JSON.stringify(payload));
          upsertRegistration(payload);
          safeSet('econodealClientRegistered', 'true');
          updateClientCountDisplays();
          hideOverlay();
        });
      }

      function baseBranches(){
        return [
          {label:'Montréal', slug:'montreal', city:'Montréal'},
          {label:'Laval', slug:'laval', city:'Laval'},
          {label:'Saint-Jérôme', slug:'saint-jerome', city:'Saint-Jérôme'}
        ];
      }
      function fullBestBuyBranches(){
        return [
          {label:'Anjou (1)', slug:'anjou', city:'Anjou'},
          {label:'Baie Comeau (1)', slug:'baie-comeau', city:'Baie-Comeau'},
          {label:'Beloeil (1)', slug:'beloeil', city:'Beloeil'},
          {label:'Brossard (1)', slug:'brossard', city:'Brossard'},
          {label:'Chomedey (2)', slug:'chomedey', city:'Chomedey'},
          {label:'Chateauguay (1)', slug:'chateauguay', city:'Chateauguay'},
          {label:'Chicoutimi (1)', slug:'chicoutimi', city:'Chicoutimi'},
          {label:'Drummondville (1)', slug:'drummondville', city:'Drummondville'},
          {label:'Gatineau (3)', slug:'gatineau', city:'Gatineau'},
          {label:'Granby (1)', slug:'granby', city:'Granby'},
          {label:'Joliette (1)', slug:'joliette', city:'Joliette'},
          {label:'LaSalle (1)', slug:'lasalle', city:'LaSalle'},
          {label:'Laval (2)', slug:'laval-best-buy', city:'Laval'},
          {label:'Longueuil (1)', slug:'longueuil', city:'Longueuil'},
          {label:'Mascouche (1)', slug:'mascouche', city:'Mascouche'},
          {label:'Montmagny (1)', slug:'montmagny', city:'Montmagny'},
          {label:'Montreal (2)', slug:'montreal-best-buy', city:'Montréal'},
          {label:'Pointe-Claire (2)', slug:'pointe-claire', city:'Pointe-Claire'},
          {label:'Quebec (4)', slug:'quebec', city:'Québec'},
          {label:'Rawdon (1)', slug:'rawdon', city:'Rawdon'},
          {label:'Repentigny (2)', slug:'repentigny', city:'Repentigny'},
          {label:'Rimouski (1)', slug:'rimouski', city:'Rimouski'},
          {label:'Riviere Du Loup (1)', slug:'riviere-du-loup', city:'Rivière-du-Loup'},
          {label:'Rosemere (1)', slug:'rosemere', city:'Rosemère'},
          {label:'Rouyn Noranda (1)', slug:'rouyn-noranda', city:'Rouyn-Noranda'},
          {label:'Saint-Eustache (1)', slug:'saint-eustache', city:'Saint-Eustache'},
          {label:'Saint-Hyacinthe (1)', slug:'saint-hyacinthe', city:'Saint-Hyacinthe'},
          {label:'Saint-Jean-sur-Richelieu (1)', slug:'saint-jean-sur-richelieu', city:'Saint-Jean-sur-Richelieu'},
          {label:'Saint-Jerome (1)', slug:'saint-jerome', city:'Saint-Jérôme'},
          {label:'Sainte-Marie (1)', slug:'sainte-marie', city:'Sainte-Marie'},
          {label:'Sept Iles (1)', slug:'sept-iles', city:'Sept-Îles'},
          {label:'Sherbrooke (1)', slug:'sherbrooke', city:'Sherbrooke'},
          {label:'St Georges (1)', slug:'st-georges', city:'Saint-Georges'},
          {label:'St Hyacinthe (1)', slug:'st-hyacinthe', city:'Saint-Hyacinthe'},
          {label:'St Jerome (1)', slug:'st-jerome', city:'Saint-Jérôme'},
          {label:'St-Bruno-de Montarville (1)', slug:'st-bruno-de-montarville', city:'Saint-Bruno-de-Montarville'},
          {label:'Terrebonne (1)', slug:'terrebonne', city:'Terrebonne'},
          {label:'Thetford Mines (1)', slug:'thetford-mines', city:'Thetford Mines'},
          {label:'Trois-Rivieres (1)', slug:'trois-rivieres', city:'Trois-Rivières'},
          {label:"Val-d'Or (1)", slug:'val-d-or', city:"Val-d'Or"},
          {label:'Vaudreuil-Dorion (1)', slug:'vaudreuil-dorion', city:'Vaudreuil-Dorion'},
          {label:'Victoriaville (1)', slug:'victoriaville', city:'Victoriaville'},
          {label:'Ville Mont Royal (1)', slug:'ville-mont-royal', city:'Mont-Royal'}
        ];
      }
      const WALMART_QUEBEC_BRANCHES = [
        {label: 'Alma — Walmart #10036849', slug: 'alma-10036849', city: 'Alma', hasData: false},
        {label: 'Baie-Comeau — Walmart #10036620', slug: 'baie-comeau-10036620', city: 'Baie-Comeau', hasData: false},
        {label: 'Beauport — Walmart #10036820', slug: 'beauport-10036820', city: 'Beauport', hasData: false},
        {label: 'Blainville — Walmart Supercentre #1185', slug: 'blainville-1185', city: 'Blainville', hasData: false},
        {label: 'Brossard — Walmart #10036625', slug: 'brossard-10036625', city: 'Brossard', hasData: false},
        {label: 'Candiac — Walmart', slug: 'candiac-201-rue-de-strasbourg', city: 'Candiac', hasData: false},
        {label: 'Cap-de-la-Madeleine — Walmart #10036632', slug: 'cap-de-la-madeleine-10036632', city: 'Cap-de-la-Madeleine', hasData: false},
        {label: 'Châteauguay — Walmart Supercentre #1132', slug: 'chateauguay-1132', city: 'Châteauguay', hasData: false},
        {label: 'Chicoutimi — Walmart #10036635', slug: 'chicoutimi-10036635', city: 'Chicoutimi', hasData: false},
        {label: 'Cowansville — Walmart #10036857', slug: 'cowansville-10036857', city: 'Cowansville', hasData: false},
        {label: 'Drummondville — Walmart #10036641', slug: 'drummondville-10036641', city: 'Drummondville', hasData: false},
        {label: 'Gatineau — Walmart #10036601', slug: 'gatineau-10036601', city: 'Gatineau', hasData: false},
        {label: 'Gatineau — Walmart #10036743', slug: 'gatineau-10036743', city: 'Gatineau', hasData: false},
        {label: 'Granby — Walmart #10036653', slug: 'granby-10036653', city: 'Granby', hasData: false},
        {label: 'Hull — Walmart #10036761', slug: 'hull-10036761', city: 'Hull', hasData: false},
        {label: 'Joliette — Walmart #10036657', slug: 'joliette-10036657', city: 'Joliette', hasData: false},
        {label: 'Kirkland — Walmart #10036662', slug: 'kirkland-10036662', city: 'Kirkland', hasData: false},
        {label: 'La Pocatière — Walmart', slug: 'la-pocatiere-160-qc-230', city: 'La Pocatière', hasData: false},
        {label: 'Lac-Mégantic — Walmart #10036547', slug: 'lac-megantic-10036547', city: 'Lac-Mégantic', hasData: false},
        {label: 'Lachenaie — Walmart #10036600', slug: 'lachenaie-10036600', city: 'Lachenaie', hasData: false},
        {label: 'Lachute — Walmart #10036750', slug: 'lachute-10036750', city: 'Lachute', hasData: false},
        {label: 'LaSalle — Walmart #10036664', slug: 'lasalle-10036664', city: 'LaSalle', hasData: false},
        {label: 'Laval — Walmart Supercentre #10036665', slug: 'laval', city: 'Laval', hasData: true},
        {label: 'Laval Est — Walmart #10036558', slug: 'laval-est-10036558', city: 'Laval Est', hasData: false},
        {label: 'Lévis — Walmart #3148', slug: 'levis-3148', city: 'Lévis', hasData: false},
        {label: 'Longueuil — Walmart #1167', slug: 'longueuil-1167', city: 'Longueuil', hasData: false},
        {label: 'Magog — Walmart #10036592', slug: 'magog-10036592', city: 'Magog', hasData: false},
        {label: 'Mascouche — Walmart #10036767', slug: 'mascouche-10036767', city: 'Mascouche', hasData: false},
        {label: 'Matane — Walmart #10036551', slug: 'matane-10036551', city: 'Matane', hasData: false},
        {label: 'Montréal — Walmart #10036783', slug: 'montreal', city: 'Montréal', hasData: true},
        {label: 'Montréal-Nord — Walmart #10036828', slug: 'montreal-nord-10036828', city: 'Montréal-Nord', hasData: false},
        {label: 'Québec — Walmart #10036692', slug: 'quebec-10036692', city: 'Québec', hasData: false},
        {label: 'Repentigny — Walmart #10036697', slug: 'repentigny-10036697', city: 'Repentigny', hasData: false},
        {label: 'Rimouski — Walmart #10036809', slug: 'rimouski-10036809', city: 'Rimouski', hasData: false},
        {label: 'Rivière-du-Loup — Walmart #10036827', slug: 'riviere-du-loup-10036827', city: 'Rivière-du-Loup', hasData: false},
        {label: 'Rosemère — Walmart #10036698', slug: 'rosemere-10036698', city: 'Rosemère', hasData: false},
        {label: 'Rouyn-Noranda — Walmart #10036754', slug: 'rouyn-noranda-10036754', city: 'Rouyn-Noranda', hasData: false},
        {label: 'Saint-Bruno-de-Montarville — Walmart #10036758', slug: 'saint-bruno-de-montarville-10036758', city: 'Saint-Bruno-de-Montarville', hasData: false},
        {label: 'Saint-Constant — Walmart #10036817', slug: 'saint-constant-10036817', city: 'Saint-Constant', hasData: false},
        {label: 'Saint-Eustache — Walmart #10036707', slug: 'saint-eustache-10036707', city: 'Saint-Eustache', hasData: false},
        {label: 'Saint-Georges — Walmart #10036565', slug: 'saint-georges-10036565', city: 'Saint-Georges', hasData: false},
        {label: 'Saint-Hyacinthe — Walmart #10036755', slug: 'saint-hyacinthe-10036755', city: 'Saint-Hyacinthe', hasData: false},
        {label: 'Saint-Jean-sur-Richelieu — Walmart #10036708', slug: 'saint-jean-sur-richelieu-10036708', city: 'Saint-Jean-sur-Richelieu', hasData: false},
        {label: 'Saint-Jérôme — Walmart #10036803', slug: 'saint-jerome', city: 'Saint-Jérôme', hasData: true},
        {label: 'Saint-Léonard — Walmart #10036712', slug: 'saint-leonard-10036712', city: 'Saint-Léonard', hasData: false},
        {label: 'Saint-Romuald — Walmart #10036569', slug: 'saint-romuald-10036569', city: 'Saint-Romuald', hasData: false},
        {label: 'Sainte-Agathe-des-Monts — Walmart #10036548', slug: 'sainte-agathe-des-monts-10036548', city: 'Sainte-Agathe-des-Monts', hasData: false},
        {label: 'Sainte-Foy — Walmart #10036764', slug: 'sainte-foy-10036764', city: 'Sainte-Foy', hasData: false},
        {label: 'Salaberry-de-Valleyfield — Walmart #10036815', slug: 'salaberry-de-valleyfield-10036815', city: 'Salaberry-de-Valleyfield', hasData: false},
        {label: 'Sept-Îles — Walmart #10036703', slug: 'sept-iles-10036703', city: 'Sept-Îles', hasData: false},
        {label: 'Shawinigan — Walmart #10036821', slug: 'shawinigan-10036821', city: 'Shawinigan', hasData: false},
        {label: 'Sherbrooke — Walmart #10036704', slug: 'sherbrooke-10036704', city: 'Sherbrooke', hasData: false},
        {label: 'Sainte-Dorothée — Walmart #10036802', slug: 'sainte-dorothee-10036802', city: 'Sainte-Dorothée', hasData: false},
        {label: 'Thetford Mines — Walmart #10036853', slug: 'thetford-mines-10036853', city: 'Thetford Mines', hasData: false},
        {label: 'Trois-Rivières — Walmart #10036726', slug: 'trois-rivieres-10036726', city: 'Trois-Rivières', hasData: false},
        {label: "Val-d'Or — Walmart #10036757", slug: 'val-d-or-10036757', city: "Val-d'Or", hasData: false},
        {label: 'Vaudreuil-Dorion — Walmart #10036578', slug: 'vaudreuil-dorion-10036578', city: 'Vaudreuil-Dorion', hasData: false},
        {label: 'Victoriaville — Walmart #10036836', slug: 'victoriaville-10036836', city: 'Victoriaville', hasData: false}
      ];

      const STORES = [
        {label:'Best Buy', slug:'best-buy', branches: fullBestBuyBranches()},
        {label:'Home Depot', slug:'home-depot', branches: baseBranches()},
        {label:'Walmart', slug:'walmart', branches: WALMART_QUEBEC_BRANCHES},
        {label:'Canadian Tire', slug:'canadian-tire', branches: baseBranches()},
        {label:'Rona', slug:'rona', branches: baseBranches()},
        {label:'Patrick Morin', slug:'patrick-morin', branches: baseBranches()},
        {label:'Sporting Life', slug:'sporting-life', branches: baseBranches()}
      ];

      function slugify(value){
        if(value === undefined || value === null) return '';
        const text = String(value).normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        return text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/--+/g,'-');
      }
      function firstDefined(...values){
        for(const value of values){ if(value !== undefined && value !== null && value !== '') return value; }
        return null;
      }
      function toNumber(value){
        if(typeof value === 'number' && Number.isFinite(value)) return value;
        if(typeof value === 'string' && value.trim()){
          const parsed = Number(value.replace(/[^0-9,.-]/g,'').replace(',','.'));
          return Number.isFinite(parsed) ? parsed : null;
        }
        return null;
      }
      function normalizeDeal(item, storeLabel, branch){
        const branchLabel = typeof branch === 'object' && branch ? branch.label : branch;
        const branchSlug = typeof branch === 'object' && branch && branch.slug ? branch.slug : slugify(branchLabel || item.city || storeLabel);
        const cityLabel = typeof branch === 'object' && branch && branch.city ? branch.city : firstDefined(item.city, branchLabel, storeLabel);
        const citySlug = slugify(cityLabel);
        const regular = toNumber(firstDefined(item.original_price, item.originalPrice, item.regular_price, item.regularPrice, item.price_before, item.priceBefore, item.listPrice, item.price));
        const sale = toNumber(firstDefined(item.salePrice, item.sale_price, item.discount_price, item.discountPrice, item.current_price, item.currentPrice, item.price));
        const finalRegular = regular ?? sale ?? 0;
        const finalSale = sale ?? regular ?? 0;
        return {
          title: firstDefined(item.title, item.name, 'Article en liquidation'),
          image: firstDefined(item.image, item.image_url, item.imageUrl, item.img, 'https://via.placeholder.com/400x300?text=Liquidation'),
          price: finalRegular,
          salePrice: finalSale,
          store: item.store ?? storeLabel,
          city: item.city ?? cityLabel,
          branch: branchLabel ?? cityLabel,
          branchSlug,
          citySlug,
          url: firstDefined(item.url, item.link, '#')
        };
      }
      function discount(p,s){
        const price = Number(p);
        const sale = Number(s);
        if(!Number.isFinite(price) || price <= 0) return 0;
        if(!Number.isFinite(sale)) return 0;
        const clampedSale = Math.max(0, sale);
        const pct = Math.round((1 - (clampedSale / price)) * 100);
        return Number.isFinite(pct) ? Math.max(pct, 0) : 0;
      }
      function currency(n){ return Number.isFinite(n) ? n.toLocaleString('fr-CA',{style:'currency',currency:'CAD'}) : '—'; }
      function filePathFor(store, branch){
        const s = store?.slug;
        const c = typeof branch === 'object' ? branch?.slug : branch;
        if(!s || !c) return null;
        return `data/${s}/${c}.json`;
      }

      async function loadCanadianTireDirectory(){
        const store = STORES.find(entry => entry.slug === 'canadian-tire');
        if(!store) return;
        try{
          const res = await fetch('data/canadian-tire/stores.json', {cache:'no-store'});
          if(!res.ok) return;
          const json = await res.json();
          if(!Array.isArray(json)) return;
          const seen = new Map();
          for(const branch of store.branches ?? []){
            seen.set(branch.slug, {...branch, hasData:true});
          }
          for(const entry of json){
            if(!entry || typeof entry !== 'object') continue;
            const rawSlug = typeof entry.slug === 'string' && entry.slug ? entry.slug : slugify(entry.nickname || entry.city || entry.label);
            if(!rawSlug) continue;
            const label = (entry.nickname || (entry.label || '').replace(/^Canadian Tire\s*/i, '') || entry.city || rawSlug).trim();
            const city = entry.city || label;
            seen.set(rawSlug, {label, slug: rawSlug, city});
          }
          store.branches = Array.from(seen.values()).sort((a,b)=>a.label.localeCompare(b.label,'fr'));
        }catch(err){
          console.warn('Impossible de charger les succursales Canadian Tire', err);
        }
      }

      async function fetchOne(path, storeLabel, branch){
        try{
          const res = await fetch(path, {cache:'no-store'});
          if(!res.ok) return {entries:[], updatedAt:null};
          let updatedAt = null;
          const lastModified = res.headers?.get?.('Last-Modified');
          if(lastModified){
            const parsed = Date.parse(lastModified);
            if(Number.isFinite(parsed)) updatedAt = parsed;
          }
          const json = await res.json();
          if(!Array.isArray(json)) return {entries:[], updatedAt};
          return {
            entries: json.map(item => normalizeDeal(item, storeLabel, branch)),
            updatedAt
          };
        }catch(error){
          console.warn('fetch fail', path, error);
          return {entries:[], updatedAt:null};
        }
      }

      let allDeals = [];
      function render(){
        const filter = storeFilter.value;
        const subset = filter ? allDeals.filter(deal => deal.store === filter) : allDeals;
        const sorted = subset
          .map(deal => ({...deal, discountPct: discount(deal.price, deal.salePrice)}))
          .filter(deal => deal.discountPct > 0)
          .sort((a,b) => {
            if(b.discountPct !== a.discountPct) return b.discountPct - a.discountPct;
            return (a.salePrice ?? Number.POSITIVE_INFINITY) - (b.salePrice ?? Number.POSITIVE_INFINITY);
          });
        const top = sorted.slice(0, 100);
        dealCount.textContent = top.length.toString();
        if(top.length === 0){
          cardsEl.innerHTML = '';
          emptyState.style.display = '';
          return;
        }
        emptyState.style.display = 'none';
        cardsEl.innerHTML = top.map(deal => `
          <article class="card">
            <img src="${deal.image}" alt="${deal.title}" loading="lazy" />
            <div class="body">
              <div class="badge">-${deal.discountPct}% Rabais</div>
              <h3>${deal.title}</h3>
              <div class="muted">${deal.store} · ${deal.branch ?? deal.city ?? ''}</div>
              <div class="price"><div class="old">${currency(deal.price)}</div><div>${currency(deal.salePrice)}</div></div>
              <a class="nav-button" href="${deal.url || '#'}" target="_blank" rel="noopener" style="justify-content:center;width:100%">Voir l'offre</a>
            </div>
          </article>`).join('');
      }

      async function fetchAllDeals(){
        statusBanner.classList.remove('error');
        statusText.textContent = 'Analyse des dernières collectes en cours...';
        const tasks = [];
        for(const store of STORES){
          const branches = store.branches ?? [];
          for(const branch of branches){
            const path = filePathFor(store, branch);
            if(path) tasks.push({store, branch, path});
          }
        }
        const seen = new Set();
        const aggregated = [];
        let latestUpdated = 0;
        for(const task of tasks){
          if(seen.has(task.path)) continue;
          seen.add(task.path);
          const {entries, updatedAt} = await fetchOne(task.path, task.store.label, task.branch);
          for(const entry of entries){ aggregated.push(entry); }
          if(updatedAt && updatedAt > latestUpdated){ latestUpdated = updatedAt; }
        }
        return {deals: aggregated, lastUpdated: latestUpdated || null};
      }

      function populateStoreFilter(){
        const options = ['<option value="">Tous les détaillants</option>'];
        for(const store of STORES){
          options.push(`<option value="${store.label}">${store.label}</option>`);
        }
        storeFilter.innerHTML = options.join('');
      }

      populateStoreFilter();
      storeFilter.addEventListener('change', render);

      await loadCanadianTireDirectory();
      try{
        const result = await fetchAllDeals();
        allDeals = result.deals;
        let displayDate;
        if(result.lastUpdated){
          displayDate = new Date(result.lastUpdated);
        }else{
          displayDate = new Date();
        }
        statusText.textContent = `Dernière collecte analysée le ${displayDate.toLocaleString('fr-CA', {dateStyle:'medium', timeStyle:'short'})}`;
      }catch(err){
        console.error('Impossible de récupérer les liquidations', err);
        statusText.textContent = "Erreur lors du chargement des liquidations.";
        statusBanner.classList.add('error');
      }
      render();
    });
  </script>
</body>
</html>
