name: Scrape CanadianTire - St-Jérôme

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # every day at 03:00 UTC

jobs:
  scrape:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-scraper.txt

      - name: Install Playwright browsers (stable)
        run: |
          python -m playwright install chromium

      - name: Export proxies env vars from GitHub Secrets
        env:
          PROXY1_SERVER: ${{ secrets.PROXY1_SERVER }}
          PROXY2_SERVER: ${{ secrets.PROXY2_SERVER }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
        run: echo "Proxy secrets exported"

      - name: Run scraper
        env:
          PROXY1_SERVER: ${{ secrets.PROXY1_SERVER }}
          PROXY2_SERVER: ${{ secrets.PROXY2_SERVER }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
          LIQUIDATION_URL: "https://www.canadiantire.ca/fr/promotions/liquidation.html?store=271"
        run: python scrape_canadiantire_stjerome.py

      - name: Upload CSV & HTML artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canadiantire-st-jerome-results
          path: |
            liquidation_st_jerome.csv
            preview.html
            debug_last_response.html
