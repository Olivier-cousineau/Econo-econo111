# (05:00 America/Toronto, 1/7 de la liste par jour, commit uniquement le JSON du magasin)

name: Canadian Tire - Multi Stores (Sharded 1/7)

on:
  schedule:
    # 05:00 America/Toronto ≈ 10:00 UTC (heure d'hiver)
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      stores: ${{ steps.make-matrix.outputs.stores }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (matrix gen)
        run: npm i minimist

      - name: Compute shard index for America/Toronto
        id: dow
        run: |
          echo "TZ=America/Toronto" >> $GITHUB_ENV
          DOW=$(TZ=America/Toronto date +%w)   # 0=dimanche .. 6=samedi
          echo "shard=${DOW}" >> $GITHUB_OUTPUT

      - name: Build matrix (1/7)
        id: make-matrix
        run: |
          node scripts/ct_make_matrix.js \
            --file data/canadian-tire/stores_raw.txt \
            --shards 7 \
            --shard ${{ steps.dow.outputs.shard }} > matrix.json
          echo "stores=$(cat matrix.json)" >> $GITHUB_OUTPUT
          echo "Matrix for shard ${{ steps.dow.outputs.shard }}:"
          cat matrix.json

  scrape:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.prepare-matrix.outputs.stores) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          npm ci || npm i
          npm i slugify minimist
          npx playwright install --with-deps chromium

      - name: Scrape ${{ matrix.city }} (store ${{ matrix.store }})
        id: scrape
        run: |
          set -e
          node scraper_ct.js \
            --store "${{ matrix.store }}" \
            --city "${{ matrix.city }}" \
            --maxPages 120 | tee scrape.log

      - name: Compute store output path (same slug as scraper)
        id: outpath
        env:
          MATRIX_STORE: ${{ matrix.store }}
          MATRIX_CITY: ${{ matrix.city }}
        run: |
          node - <<'NODE' > .store_path
          const slugify = require('slugify');
          const store = process.env.MATRIX_STORE;
          const city = process.env.MATRIX_CITY || "";

          if (!store) {
            throw new Error('Identifiant du magasin non défini');
          }

          const slug = slugify(city, { lower: true, strict: true });
          if (!slug) {
            throw new Error('Slug du store non défini');
          }

          const path = `outputs/canadiantire/${store}-${slug}`;
          console.error('Chemin généré:', path);
          process.stdout.write(path);
          NODE
          echo "path=$(cat .store_path)" >> $GITHUB_OUTPUT

      - name: Commit only this store’s JSON
        run: |
          STORE_PATH='${{ steps.outpath.outputs.path }}'
          echo "Committing: $STORE_PATH/data.json"
          git config user.name "EconoDeal Bot"
          git config user.email "bot@econodeal.local"
          git add "$STORE_PATH/data.json"
          ROWS=$(jq 'length' "$STORE_PATH/data.json" 2>/dev/null || echo "?")
          git commit -m "CT shard: ${ROWS} items → $STORE_PATH/data.json" || echo "No changes"
          git push || true

  publish-datasets:
    needs: scrape
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (latest main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Sync with origin/main
        run: |
          git fetch origin main
          git checkout main
          git pull --rebase origin main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Publish normalized Canadian Tire datasets
        run: npm run publish:canadiantire

      - name: Commit normalized feeds
        run: |
          git config --global user.name "EconoDeal Bot"
          git config --global user.email "bot@econodeal.local"
          find data/canadian-tire -maxdepth 1 -name '*.json' -print0 | xargs -0 -r git add
          git commit -m "CT shard: publish normalized datasets" || echo "Nothing to commit"
          git push || true

