name: üß© EconoDeal ‚Äì Canadian Tire Scraper

on:
  # üìÖ Ex√©cution automatique chaque soir √† 21h (Qu√©bec) = 01:00 UTC
  schedule:
    - cron: "0 1 * * *"
  # ‚ñ∂Ô∏è Permet aussi de le lancer manuellement depuis l‚Äôonglet ‚ÄúActions‚Äù
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√®re ton d√©p√¥t GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Debug : affiche la structure du d√©p√¥t (utile si le chemin est faux)
      - name: Show repository structure (debug)
        run: |
          echo "üìÇ Current repository structure:"
          pwd
          ls -R | head -n 100

      # 3Ô∏è‚É£ S‚Äôassure que le dossier existe et ajoute 3 magasins de test si besoin
      - name: Ensure required folders and sample IDs
        run: |
          mkdir -p data/canadiantire
          if [ ! -f "data/canadiantire/stores_ids.txt" ]; then
            echo "0271" > data/canadiantire/stores_ids.txt
            echo "0649" >> data/canadiantire/stores_ids.txt
            echo "0418" >> data/canadiantire/stores_ids.txt
            echo "[INFO] Created sample stores_ids.txt ‚úÖ"
          fi
          test -f scrape_canadiantire_liquidations.py || (echo "[ERROR] Missing scrape_canadiantire_liquidations.py at repo root ‚ùå" && exit 1)

      # 4Ô∏è‚É£ Installe Python et les d√©pendances n√©cessaires
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (Playwright, Pandas, etc.)
        run: |
          python -m pip install --upgrade pip
          pip install playwright aiofiles pandas tqdm
          python -m playwright install-deps
          python -m playwright install

      # 5Ô∏è‚É£ Ex√©cute le scraper principal
      - name: Run EconoDeal ‚Äì Canadian Tire scraper
        env:
          CT_CONCURRENCY: "3"        # Nombre de magasins simultan√©s
          CT_DELAY_BASE: "1.6"       # D√©lai minimum entre chargements
          CT_DELAY_JITTER: "1.4"     # Variabilit√© al√©atoire
        run: |
          python scrape_canadiantire_liquidations.py --stores-file data/canadiantire/stores_ids.txt

      # 6Ô∏è‚É£ Sauvegarde les r√©sultats de scraping dans un ‚Äúartifact‚Äù t√©l√©chargeable
      - name: Upload scraping results
        uses: actions/upload-artifact@v4
        with:
          name: canadiantire-results
          path: output_canadiantire/**

      # 7Ô∏è‚É£ Commit automatique des fichiers extraits dans ton d√©p√¥t
      - name: Commit and push results to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add output_canadiantire || true
          git commit -m "üß© Canadian Tire scrape $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No new data to commit"
          git push
