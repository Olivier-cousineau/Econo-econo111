name: 🧩 EconoDeal – Canadian Tire Scraper (503 stores)

on:
  # ⏰ Exécution automatique chaque soir à 21h (heure du Québec)
  schedule:
    - cron: "0 1 * * *"
  # ▶️ Permet de le lancer manuellement depuis l’onglet “Actions”
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupère ton dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Vérifie la structure du dépôt
      - name: Show repository structure (debug)
        run: |
          echo "📂 Current repository structure:"
          pwd
          ls -R | head -n 200

      # 3️⃣ Vérifie que le fichier des magasins existe
      - name: Ensure store list file exists
        run: |
          if [ ! -f "data/canadiantire/stores_ids.txt" ]; then
            echo "[ERROR] ❌ data/canadiantire/stores_ids.txt not found!"
            exit 1
          fi
          echo "[OK] ✅ Store list detected with $(wc -l < data/canadiantire/stores_ids.txt) stores."

      # 4️⃣ Configure Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 5️⃣ Installe les dépendances
      - name: Install dependencies (Playwright, Requests, etc.)
        run: |
          python -m pip install --upgrade pip
          pip install playwright aiofiles pandas tqdm requests beautifulsoup4 lxml
          python -m playwright install-deps
          python -m playwright install

      # 6️⃣ Boucle sur les 503 magasins
      - name: Run EconoDeal – Canadian Tire scraper (503 stores)
        env:
          CT_CONCURRENCY: "3"
        run: |
          set -e
          mkdir -p output_canadiantire
          rm -f output_canadiantire/canadiantire_liquidations_all_stores.csv || true

          echo "🚀 Starting full scrape of all 503 Canadian Tire stores..."
          while IFS= read -r STORE_ID; do
            [ -z "$STORE_ID" ] && continue
            echo "▶️ Scraping store $STORE_ID"
            python scrape_canadiantire_liquidations.py \
              --store "$STORE_ID" \
              --language fr \
              --output-dir output_canadiantire \
              --aggregated-path output_canadiantire/canadiantire_liquidations_all_stores.csv \
              --max-retries 3 \
              --timeout 30000 \
              --delay 1.6 3.0
          done < data/canadiantire/stores_ids.txt

          echo "✅ Finished scraping all stores."

      # 7️⃣ Sauvegarde des résultats
      - name: Upload scraping results
        uses: actions/upload-artifact@v4
        with:
          name: canadiantire-results
          path: output_canadiantire/**

      # 8️⃣ Commit automatique dans le dépôt
      - name: Commit and push results to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add output_canadiantire || true
          git commit -m "🧩 Canadian Tire 503-store scrape $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No new data to commit"
          git push
